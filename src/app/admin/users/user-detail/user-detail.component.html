<div class="page-container user-detail-page">
    <div class="page-content">

        <!-- Loading State -->
        <div *ngIf="isLoading" class="loading-state">
            <div class="loading-spinner"></div>
            <p>جاري تحميل بيانات المستخدم...</p>
        </div>

        <!-- Error/Not Found State -->
        <app-empty-state *ngIf="!isLoading && !user" icon="person_off" title="لم يتم العثور على المستخدم"
            description="قد يكون المستخدم غير موجود أو تم حذفه">
            <app-button (click)="navigateBack()">العودة لقائمة المستخدمين</app-button>
        </app-empty-state>

        <!-- User Data Content -->
        <ng-container *ngIf="!isLoading && user">
            <!-- Hero Section with User Profile -->
            <div class="user-hero animate-fade-in">
                <div class="hero-backdrop"></div>
                <div class="hero-content">
                    <!-- Back Button -->
                    <button class="back-btn" (click)="navigateBack()">
                        <span class="material-symbols-outlined">arrow_forward</span>
                        <span>العودة</span>
                    </button>

                    <!-- Profile Card -->
                    <div class="profile-card">
                        <div class="profile-avatar">
                            <app-smart-image [src]="user.avatar" [type]="user.role === 'Referee' ? 'referee' : 'avatar'"
                                size="xl" [initials]="user.name.charAt(0)">
                            </app-smart-image>
                            <div class="status-indicator" [class.active]="user.status === 'Active'"
                                [class.inactive]="user.status !== 'Active'">
                                <span class="material-symbols-outlined">
                                    {{ user.status === 'Active' ? 'check_circle' : 'cancel' }}
                                </span>
                            </div>
                        </div>

                        <div class="profile-info">
                            <div class="profile-name-group">
                                <h1 class="profile-name">{{ user.name }}</h1>
                                <p class="profile-email">{{ user.email }}</p>
                            </div>
                            <div class="profile-meta">
                                <app-badge type="gold">
                                    <span class="material-symbols-outlined">military_tech</span>
                                    {{ getRoleLabel(user.role) }}
                                </app-badge>
                                <app-badge [type]="getBadgeType(user.status)">
                                    {{ getStatusLabel(user.status) }}
                                </app-badge>
                            </div>
                        </div>

                        <div class="profile-actions" *ngIf="!isLastAdmin() || user.status !== 'Active'">
                            <app-button (click)="toggleUserStatus()"
                                [variant]="user.status === 'Active' ? 'danger' : 'primary'"
                                [icon]="user.status === 'Active' ? 'block' : 'check_circle'" size="lg">
                                {{ user.status === 'Active' ? 'تعطيل الحساب' : 'تفعيل الحساب' }}
                            </app-button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Content Grid -->
            <div class="content-grid">
                <!-- Quick Stats Row -->
                <div class="stats-row animate-fade-in-up">
                    <div class="stat-card">
                        <div class="stat-icon">
                            <span class="material-symbols-outlined">fingerprint</span>
                        </div>
                        <div class="stat-content">
                            <span class="stat-label">المعرف</span>
                            <span class="stat-value">{{ user.id }}</span>
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon">
                            <span class="material-symbols-outlined">badge</span>
                        </div>
                        <div class="stat-content">
                            <span class="stat-label">رقم الهوية</span>
                            <span class="stat-value">{{ user.nationalId || '—' }}</span>
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon">
                            <span class="material-symbols-outlined">cake</span>
                        </div>
                        <div class="stat-content">
                            <span class="stat-label">العمر</span>
                            <span class="stat-value">{{ user.age || '—' }} سنة</span>
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon">
                            <span class="material-symbols-outlined">call</span>
                        </div>
                        <div class="stat-content">
                            <span class="stat-label">الهاتف</span>
                            <span class="stat-value font-mono">{{ user.phone || '—' }}</span>
                        </div>
                    </div>
                </div>

                <!-- Main Content Columns -->
                <div class="main-columns">
                    <!-- Left Column: Activity & Location -->
                    <div class="column-left">
                        <!-- Activity Timeline -->
                        <div class="glass-card animate-fade-in-up" style="animation-delay: 0.1s">
                            <div class="card-header">
                                <div class="card-icon">
                                    <span class="material-symbols-outlined">history</span>
                                </div>
                                <h2 class="card-title">سجل النشاط</h2>
                                <span class="activity-count" *ngIf="user.activities?.length">
                                    {{ user.activities?.length }}
                                </span>
                            </div>

                            <div class="timeline" *ngIf="user.activities && user.activities.length > 0">
                                <div *ngFor="let activity of user.activities; let i = index; let last = last"
                                    class="timeline-item" [style.animation-delay]="(i * 0.05) + 's'">
                                    <div class="timeline-dot" [ngClass]="getActivityBadgeClass(activity.type)">
                                        <span class="material-symbols-outlined">
                                            {{ getActivityIcon(activity.type) }}
                                        </span>
                                    </div>
                                    <div class="timeline-connector" *ngIf="!last"></div>
                                    <div class="timeline-content">
                                        <p class="timeline-message">{{ activity.message }}</p>
                                        <span class="timeline-time">
                                            <span class="material-symbols-outlined">schedule</span>
                                            {{ activity.createdAt | date:'yyyy/MM/dd - HH:mm' }}
                                        </span>
                                    </div>
                                </div>
                            </div>

                            <div class="empty-timeline" *ngIf="!user.activities?.length">
                                <span class="material-symbols-outlined">history_toggle_off</span>
                                <p>لا يوجد نشاط مسجل حالياً</p>
                            </div>
                        </div>
                    </div>

                    <!-- Right Column: Info & Documents -->
                    <div class="column-right">
                        <!-- Location Card -->
                        <div class="glass-card animate-fade-in-up" style="animation-delay: 0.15s">
                            <div class="card-header">
                                <div class="card-icon">
                                    <span class="material-symbols-outlined">location_on</span>
                                </div>
                                <h2 class="card-title">العنوان</h2>
                            </div>
                            <div class="location-grid">
                                <div class="location-item">
                                    <span class="location-label">المحافظة</span>
                                    <span class="location-value">{{ user.governorate || '—' }}</span>
                                </div>
                                <div class="location-item">
                                    <span class="location-label">المدينة</span>
                                    <span class="location-value">{{ user.city || '—' }}</span>
                                </div>
                                <div class="location-item full">
                                    <span class="location-label">الحي</span>
                                    <span class="location-value">{{ user.neighborhood || '—' }}</span>
                                </div>
                            </div>
                        </div>

                        <!-- Identity Documents -->
                        <div class="glass-card animate-fade-in-up" style="animation-delay: 0.2s">
                            <div class="card-header">
                                <div class="card-icon">
                                    <span class="material-symbols-outlined">verified_user</span>
                                </div>
                                <h2 class="card-title">وثائق الهوية</h2>
                            </div>
                            <div class="documents-gallery">
                                <div class="doc-card">
                                    <div class="doc-label">
                                        <span class="material-symbols-outlined">credit_card</span>
                                        <span>وجه البطاقة</span>
                                    </div>
                                    <div class="doc-image">
                                        <app-smart-image [src]="user.idFrontUrl" type="id"
                                            size="custom"></app-smart-image>
                                        <div class="doc-overlay">
                                            <span class="material-symbols-outlined">zoom_in</span>
                                        </div>
                                    </div>
                                </div>
                                <div class="doc-card">
                                    <div class="doc-label">
                                        <span class="material-symbols-outlined">credit_card</span>
                                        <span>ظهر البطاقة</span>
                                    </div>
                                    <div class="doc-image">
                                        <app-smart-image [src]="user.idBackUrl" type="id"
                                            size="custom"></app-smart-image>
                                        <div class="doc-overlay">
                                            <span class="material-symbols-outlined">zoom_in</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </ng-container>
    </div>
</div>