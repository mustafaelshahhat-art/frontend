<div class="page-container">
    <div class="page-content">

        <!-- ==================== CUSTOM CONFIRM MODAL ==================== -->
        <div *ngIf="showConfirmModal" class="confirm-overlay animate-fade-in">
            <div class="confirm-dialog confirm-danger animate-scale-in">
                <div class="confirm-visual">
                    <div class="confirm-icon-ring">
                        <div class="confirm-icon-bg">
                            <span class="material-symbols-outlined">{{ confirmType === 'player' ? 'person_remove' :
                                'delete_forever' }}</span>
                        </div>
                    </div>
                    <div class="confirm-particles">
                        <span></span><span></span><span></span>
                    </div>
                </div>

                <div class="confirm-content">
                    <h3 class="confirm-title">{{ confirmTitle }}</h3>
                    <p class="confirm-message">{{ confirmMessage }}</p>
                </div>

                <div class="confirm-actions">
                    <button (click)="closeConfirmModal()" [disabled]="isConfirmLoading"
                        class="confirm-btn confirm-btn-cancel">
                        <span class="material-symbols-outlined">arrow_back</span>
                        تراجع
                    </button>
                    <button (click)="executeConfirmAction()" [disabled]="isConfirmLoading"
                        class="confirm-btn confirm-btn-danger">
                        <span *ngIf="isConfirmLoading" class="material-symbols-outlined spinner">sync</span>
                        <span *ngIf="!isConfirmLoading" class="material-symbols-outlined">delete</span>
                        {{ isConfirmLoading ? 'جاري الحذف...' : 'تأكيد الحذف' }}
                    </button>
                </div>
            </div>
        </div>

        <!-- ==================== NO TEAM STATE (Create Team) ==================== -->
        <div *ngIf="hasNoTeam" class="create-team-page animate-fade-in-up">
            <div class="create-team-hero">
                <div class="create-team-visual">
                    <div class="hero-glow"></div>
                    <div class="hero-icon-container">
                        <div class="hero-icon-ring hero-icon-ring-1"></div>
                        <div class="hero-icon-ring hero-icon-ring-2"></div>
                        <div class="hero-icon-bg">
                            <span class="material-symbols-outlined">shield</span>
                        </div>
                    </div>
                    <div class="hero-decorations">
                        <span class="material-symbols-outlined deco-icon deco-1">sports_soccer</span>
                        <span class="material-symbols-outlined deco-icon deco-2">emoji_events</span>
                        <span class="material-symbols-outlined deco-icon deco-3">military_tech</span>
                    </div>
                </div>

                <div class="create-team-content">
                    <h1 class="create-team-title">أنشئ فريقك الأسطوري</h1>
                    <p class="create-team-subtitle">
                        ابدأ رحلتك كقائد وأسس كيانك الرياضي الخاص. اجمع أفضل اللاعبين وانطلق نحو البطولات!
                    </p>

                    <div class="create-team-features">
                        <div class="feature-item">
                            <span class="material-symbols-outlined">groups</span>
                            <span>أضف حتى 10 لاعبين</span>
                        </div>
                        <div class="feature-item">
                            <span class="material-symbols-outlined">trophy</span>
                            <span>شارك في البطولات</span>
                        </div>
                        <div class="feature-item">
                            <span class="material-symbols-outlined">leaderboard</span>
                            <span>تتبع الإحصائيات</span>
                        </div>
                    </div>

                    <button (click)="toggleCreateTeamModal()" class="create-team-btn">
                        <span class="material-symbols-outlined">add_circle</span>
                        تأسيس فريق جديد
                        <span class="btn-arrow">←</span>
                    </button>
                </div>
            </div>
        </div>

        <!-- ==================== CREATE TEAM MODAL ==================== -->
        <div *ngIf="showCreateTeamModal" class="create-modal-overlay animate-fade-in">
            <div class="create-modal animate-scale-in">
                <button (click)="toggleCreateTeamModal()" class="create-modal-close">
                    <span class="material-symbols-outlined">close</span>
                </button>

                <div class="create-modal-header">
                    <div class="create-modal-icon">
                        <span class="material-symbols-outlined">shield</span>
                    </div>
                    <h3>تأسيس كيان رياضي</h3>
                    <p>اختر اسماً مميزاً لفريقك يعكس هويته وطموحاته</p>
                </div>

                <div class="create-modal-body">
                    <div class="team-name-field">
                        <label>اسم الفريق</label>
                        <div class="team-name-input-wrapper">
                            <span class="material-symbols-outlined input-icon">badge</span>
                            <input [(ngModel)]="newTeamName" placeholder="مثال: نسور الصحراء" class="team-name-input"
                                maxlength="30">
                            <span class="char-counter">{{ newTeamName.length }}/30</span>
                        </div>
                    </div>

                    <div class="create-tips">
                        <div class="tip-item">
                            <span class="material-symbols-outlined">lightbulb</span>
                            <span>اختر اسماً فريداً يسهل تذكره</span>
                        </div>
                    </div>
                </div>

                <div class="create-modal-footer">
                    <button (click)="toggleCreateTeamModal()" class="create-modal-btn create-modal-btn-cancel">
                        إلغاء
                    </button>
                    <button (click)="createTeam()" [disabled]="isCreatingTeam || !newTeamName.trim()"
                        class="create-modal-btn create-modal-btn-confirm">
                        <span *ngIf="isCreatingTeam" class="material-symbols-outlined spinner">sync</span>
                        <span *ngIf="!isCreatingTeam" class="material-symbols-outlined">rocket_launch</span>
                        {{ isCreatingTeam ? 'جاري التأسيس...' : 'انطلق الآن' }}
                    </button>
                </div>
            </div>
        </div>

        <!-- ==================== CAPTAIN VIEW (Has Team) ==================== -->
        <div *ngIf="team && isCaptain" class="animate-fade-in-up">
            <app-page-header title="منصة قيادة الفريق"
                subtitle="أنت الآن تدير <b>{{ team.name }}</b> • القائمة الكاملة والبيانات الأساسية">

                <div class="flex gap-3 flex-wrap mb-md self-start">
                    <button (click)="toggleAddPlayerModal()" [disabled]="isTeamFull"
                        class="btn btn-primary btn-with-icon hover-lift" [class.btn-disabled]="isTeamFull">
                        <span class="material-symbols-outlined">person_add</span>
                        {{ isTeamFull ? 'القائمة مكتملة' : 'إلحاق لاعب جديد' }}
                    </button>
                    <button (click)="confirmDeleteTeam()" class="btn btn-icon btn-danger-ghost" title="حل الفريق">
                        <span class="material-symbols-outlined">delete_forever</span>
                    </button>
                </div>
            </app-page-header>

            <!-- Add Player Modal Overlay -->
            <div *ngIf="showAddPlayerModal" class="player-modal-overlay animate-fade-in">
                <div class="player-modal animate-scale-in">
                    <button (click)="toggleAddPlayerModal()" class="player-modal-close">
                        <span class="material-symbols-outlined">close</span>
                    </button>

                    <div class="player-modal-header">
                        <div class="player-modal-icon">
                            <span class="material-symbols-outlined">person_add</span>
                        </div>
                        <h3>ضم لاعب جديد</h3>
                        <p>أدخل المعرف الخاص باللاعب للانضمام إلى صفوف فريقك</p>
                    </div>

                    <div class="player-modal-body">
                        <div class="player-id-input-wrapper">
                            <span class="player-id-prefix">PLR</span>
                            <input [(ngModel)]="searchPlayerId" placeholder="أدخل رقم المعرف" class="player-id-input"
                                maxlength="10">
                            <span class="material-symbols-outlined player-id-icon">badge</span>
                        </div>
                        <p class="player-id-hint">
                            <span class="material-symbols-outlined">info</span>
                            يمكن للاعب الحصول على المعرف من صفحة حسابه الشخصي
                        </p>
                    </div>

                    <div class="player-modal-footer">
                        <button (click)="toggleAddPlayerModal()" class="player-modal-btn player-modal-btn-cancel">
                            إلغاء
                        </button>
                        <button (click)="addPlayerById()" [disabled]="isAddingPlayer || !searchPlayerId.trim()"
                            class="player-modal-btn player-modal-btn-confirm">
                            <span *ngIf="isAddingPlayer" class="material-symbols-outlined spinner">sync</span>
                            <span *ngIf="!isAddingPlayer" class="material-symbols-outlined">group_add</span>
                            {{ isAddingPlayer ? 'جاري البحث...' : 'ضم للفريق' }}
                        </button>
                    </div>
                </div>
            </div>

            <!-- Team Compact Card -->
            <div class="team-compact-card mb-xl">
                <div class="team-compact-logo" (click)="triggerLogoUpload()">
                    <img *ngIf="teamLogoUrl" [src]="teamLogoUrl" alt="شعار الفريق" class="team-logo-img">
                    <span *ngIf="!teamLogoUrl" class="material-symbols-outlined">shield</span>
                    <div class="team-logo-overlay">
                        <span class="material-symbols-outlined">add_a_photo</span>
                    </div>
                    <input type="file" #logoInput (change)="onLogoSelected($event)" accept="image/*" hidden>
                </div>

                <div class="team-compact-info">
                    <div *ngIf="!isEditingTeam" class="team-compact-details">
                        <div class="team-compact-header">
                            <h2 class="team-compact-name">{{ team.name }}</h2>
                            <button (click)="isEditingTeam = true" class="team-edit-btn" title="تعديل">
                                <span class="material-symbols-outlined">edit</span>
                            </button>
                        </div>

                        <div class="team-compact-meta">
                            <div class="team-meta-item">
                                <span class="material-symbols-outlined">military_tech</span>
                                <span>{{ team.captainName }}</span>
                            </div>
                            <div class="team-meta-divider"></div>
                            <div class="team-meta-item">
                                <span class="material-symbols-outlined">calendar_month</span>
                                <span>{{ team.founded }}</span>
                            </div>
                            <div class="team-meta-divider"></div>
                            <div class="team-meta-item" [class.text-warning]="isTeamFull">
                                <span class="material-symbols-outlined">groups</span>
                                <span>{{ players.length + 1 }}/{{ maxPlayers }}</span>
                            </div>
                        </div>
                    </div>

                    <!-- Edit Form -->
                    <div *ngIf="isEditingTeam" class="team-compact-edit">
                        <input [(ngModel)]="editedTeamName" placeholder="اسم الفريق" class="team-name-input">
                        <div class="team-edit-actions">
                            <button (click)="saveTeam()" class="btn btn-primary btn-sm">حفظ</button>
                            <button (click)="isEditingTeam = false" class="btn btn-ghost btn-sm">إلغاء</button>
                        </div>
                    </div>
                </div>

                <div class="team-capacity-indicator">
                    <svg viewBox="0 0 36 36" class="team-capacity-ring">
                        <path class="capacity-bg"
                            d="M18 2.0845 a 15.9155 15.9155 0 0 1 0 31.831 a 15.9155 15.9155 0 0 1 0 -31.831" />
                        <path class="capacity-fill" [class.capacity-warning]="isTeamFull"
                            [class.capacity-good]="!isTeamFull"
                            [attr.stroke-dasharray]="((players.length + 1) / maxPlayers) * 100 + ', 100'"
                            d="M18 2.0845 a 15.9155 15.9155 0 0 1 0 31.831 a 15.9155 15.9155 0 0 1 0 -31.831" />
                    </svg>
                    <div class="capacity-text">
                        <span class="capacity-count">{{ players.length + 1 }}</span>
                        <span class="capacity-label">لاعب</span>
                    </div>
                </div>
            </div>

            <!-- ==================== JOIN REQUESTS SECTION ==================== -->
            <div *ngIf="joinRequests.length > 0" class="mb-2xl animate-fade-in-up">
                <h3 class="section-title text-xl font-extrabold mb-xl flex items-center gap-4">
                    <span class="material-symbols-outlined text-gold">notification_important</span>
                    طلبات انضمام معلقة
                    <span class="badge badge-warning">{{ joinRequests.length }}</span>
                </h3>

                <div class="grid-cards">
                    <div *ngFor="let request of joinRequests" class="card card-glass card-warning card-hover">
                        <div class="flex items-center gap-4 mb-xl">
                            <div class="avatar avatar-warning">
                                <span class="material-symbols-outlined">person_search</span>
                            </div>
                            <div>
                                <h4 class="text-primary font-extrabold">{{ request.playerName }}</h4>
                                <p class="text-muted text-sm font-mono">ID: {{ request.playerDisplayId }}</p>
                            </div>
                        </div>

                        <div class="flex gap-3">
                            <button (click)="approveJoinRequest(request.id)" [disabled]="isTeamFull"
                                class="btn btn-primary flex-2 btn-with-icon" [class.btn-disabled]="isTeamFull">
                                <span class="material-symbols-outlined">check</span>
                                قبول الانضمام
                            </button>
                            <button (click)="rejectJoinRequest(request.id)"
                                class="btn btn-danger-ghost flex-1 btn-icon-only">
                                <span class="material-symbols-outlined">close</span>
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Players Grid -->
            <div class="section-header flex items-center gap-4 mb-xl">
                <h3 class="section-title text-xl font-extrabold flex items-center gap-3">
                    <span class="material-symbols-outlined text-primary">groups</span>
                    قائمة محاربي الفريق
                </h3>
                <div class="section-divider"></div>
                <span class="badge badge-primary">{{ players.length }} محارب</span>
            </div>

            <div *ngIf="players.length === 0" class="empty-state empty-state-sm">
                <span class="material-symbols-outlined empty-state-icon-muted">group_off</span>
                <h4 class="text-lg font-bold text-primary">القائمة خالية حالياً</h4>
                <p class="text-muted">ابدأ بتجميع فريقك بإضافة اللاعبين عبر المعرف الخاص بهم</p>
            </div>

            <div class="grid-cards">
                <div *ngFor="let player of players; let i = index"
                    class="card card-glass card-hover player-card animate-fade-in-up">
                    <div class="flex items-center gap-4">
                        <div class="avatar avatar-primary avatar-lg">
                            <span class="material-symbols-outlined">account_circle</span>
                        </div>
                        <div class="flex-1 min-w-0">
                            <h4 class="text-primary font-bold text-truncate">{{ player.name }}</h4>
                            <p class="text-muted text-sm font-mono">ID: {{ player.displayId }}</p>
                        </div>
                        <button (click)="confirmRemovePlayer(player)" class="btn btn-icon btn-danger-ghost"
                            title="استبعاد من الفريق">
                            <span class="material-symbols-outlined">person_remove</span>
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- ==================== PLAYER IN TEAM VIEW (View Only) ==================== -->
        <div *ngIf="team && isPlayerInTeam" class="animate-fade-in-up">
            <app-page-header title="أكاديمية الفريق" subtitle="أنت حالياً عضو نشط في <b>{{ team.name }}</b>">
            </app-page-header>

            <!-- Team Info Card (View Only) -->
            <div class="card card-glass card-hero mb-2xl">
                <div class="team-avatar team-avatar-lg">
                    <span class="material-symbols-outlined">sports_soccer</span>
                </div>
                <div class="team-info">
                    <h2 class="text-2xl font-extrabold text-primary mb-4">{{ team.name }}</h2>
                    <div class="flex items-center gap-4 flex-wrap">
                        <div class="badge badge-success badge-lg">
                            <span class="material-symbols-outlined">crown</span>
                            القائد: {{ team.captainName }}
                        </div>
                        <div class="badge badge-primary">
                            <span class="material-symbols-outlined">group_work</span>
                            {{ players.length + 1 }} لاعبين في القائمة
                        </div>
                    </div>
                </div>
            </div>

            <!-- Teammates Grid (View Only) -->
            <div class="section-header flex items-center gap-4 mb-xl">
                <h3 class="section-title text-xl font-extrabold flex items-center gap-3">
                    <span class="material-symbols-outlined text-primary">sports_handball</span>
                    رفاقه في الميدان
                </h3>
                <div class="section-divider"></div>
            </div>

            <div class="grid-cards grid-cards-sm">
                <div *ngFor="let player of players; let i = index"
                    class="card card-glass player-card-sm animate-fade-in-up">
                    <div class="avatar avatar-success">
                        <span class="material-symbols-outlined">person</span>
                    </div>
                    <div>
                        <h4 class="text-primary font-semibold">{{ player.name }}</h4>
                        <span class="text-muted text-sm">زميل الفريق</span>
                    </div>
                </div>
            </div>
        </div>

    </div>
</div>