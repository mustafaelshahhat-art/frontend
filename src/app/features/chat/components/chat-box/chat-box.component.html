<div class="chat-container">
    <!-- Chat Sidebar (Desktop Only or Toggled) -->
    <div class="chat-sidebar" [class.open]="sidebarOpen" [class.hidden-mobile]="!sidebarOpen">
        <div class="chat-sidebar-header">
            <div class="chat-sidebar-title">
                <span class="material-symbols-outlined">group</span>
                المسؤولون
            </div>
            <div class="chat-sidebar-count">{{ participants.length + 1 }}</div>
        </div>

        <div class="chat-sections">
            <!-- Referee Section -->
            <div *ngIf="referee" class="chat-section">
                <div class="chat-section-label">
                    <span>حكم المباراة</span>
                    <div class="chat-section-line"></div>
                </div>
                <div class="chat-referee-card">
                    <div class="chat-referee-avatar">
                        {{ referee.name.charAt(0) }}
                    </div>
                    <div class="chat-referee-info">
                        <h4 class="chat-referee-name">{{ referee.name }}</h4>
                        <div class="chat-referee-status">
                            <span class="material-symbols-outlined icon-xs text-info">verified</span>
                            <span class="chat-referee-status-text">حكم الساحة</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Participants Section -->
            <div class="chat-section">
                <div class="chat-section-label">
                    <span>المشاركون</span>
                    <div class="chat-section-line"></div>
                </div>
                <div class="chat-participant-list">
                    <div *ngFor="let p of participants; trackBy: trackByParticipant" class="chat-participant-item">
                        <div class="chat-participant-avatar"
                            [class.chat-participant-avatar-home]="p.teamId === match?.homeTeamId"
                            [class.chat-participant-avatar-away]="p.teamId !== match?.awayTeamId">
                            {{ p.name.charAt(0) }}
                        </div>
                        <div class="chat-participant-info">
                            <h5 class="chat-participant-name">{{ p.name }}</h5>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Main Chat Panel -->
    <div class="chat-panel">
        <div class="chat-header">
            <div class="chat-header-actions md-hidden">
                <app-icon-button (onClick)="toggleSidebar()" icon="menu" variant="ghost"></app-icon-button>
            </div>

            <div class="chat-header-info">
                <div class="icon-wrapper bg-primary-subtle">
                    <span class="material-symbols-outlined text-primary">forum</span>
                </div>
                <div>
                    <h2 class="chat-title">{{ title }}</h2>
                    <div class="chat-subtitle">
                        {{ match?.homeTeamName }} <span class="chat-subtitle-vs">VS</span> {{ match?.awayTeamName }}
                    </div>
                </div>
            </div>

            <div class="chat-header-actions">
                <div class="online-status">
                    <span class="live-dot"></span>
                    <span class="online-status-text">متصل</span>
                </div>
                <app-icon-button (onClick)="navigateBack()" icon="arrow_forward" variant="ghost"></app-icon-button>
            </div>
        </div>

        <!-- Messages Area -->
        <div class="chat-messages" #scrollContainer>
            <div *ngIf="messages.length === 0" class="chat-empty">
                <div class="chat-empty-icon">
                    <span class="material-symbols-outlined">chat_bubble_outline</span>
                </div>
                <h3 class="chat-empty-title">لا توجد رسائل بعد</h3>
                <p class="chat-empty-subtitle">ابدأ المحادثة مع الحكم والفرق الأخرى</p>
            </div>

            <div *ngFor="let msg of messages; trackBy: trackByMessage" class="chat-message"
                [class.chat-message-me]="isMe(msg)" [class.chat-message-other]="!isMe(msg)">

                <div class="chat-message-sender" [class.chat-message-sender-reversed]="isMe(msg)">
                    <span class="chat-message-name">{{ msg.senderName }}</span>
                    <span *ngIf="msg.senderRole" class="chat-message-role"
                        [class.bg-primary-subtle]="msg.senderRole === 'captain'"
                        [class.bg-info-subtle]="msg.senderRole === 'referee'"
                        [class.text-primary]="msg.senderRole === 'captain'"
                        [class.text-info]="msg.senderRole === 'referee'">
                        {{ msg.senderRole }}
                    </span>
                </div>

                <div class="chat-bubble" [class.chat-bubble-me]="isMe(msg)" [class.chat-bubble-other]="!isMe(msg)">
                    {{ msg.text }}
                </div>
                <div class="chat-message-time">{{ msg.timestamp | date:'shortTime' }}</div>
            </div>
        </div>

        <!-- Input Area -->
        <div class="chat-input-area">
            <div class="chat-input-wrapper">
                <app-form-control type="text" [(ngModel)]="newMessage"
                    [placeholder]="readOnly ? 'هذه المباراة انتهت، المحادثة للقراءة فقط' : 'اكتب رسالتك هنا...'"
                    [disabled]="isLoading || readOnly" (keydown.enter)="sendMessage()" style="flex: 1;">
                </app-form-control>

                <app-icon-button (onClick)="sendMessage()" icon="send" variant="primary"
                    [disabled]="!newMessage.trim() || isLoading || readOnly" [isLoading]="isLoading">
                </app-icon-button>
            </div>
        </div>
    </div>
</div>