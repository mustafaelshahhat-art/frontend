<div class="chat-page">
    @if (!isLoading && isAuthorized && match) {
    <app-chat-box [title]="match.homeTeamName + ' vs ' + match.awayTeamName" [match]="match" [messages]="mappedMessages"
        [currentUserId]="currentUser?.id || ''" [participants]="participants" [referee]="getReferee() || null"
        [readOnly]="isMatchFinished" [canSchedule]="canScheduleMatch()" (back)="goBack()" (send)="onSendMessage($event)"
        (schedule)="openScheduleModal()" />
    }

    <!-- Schedule Modal -->
    <app-modal [visible]="showScheduleModal" title="تحديد موعد اللقاء" icon="calendar_month"
        (closeRequest)="closeScheduleModal()">
        <div class="form-grid">
            <div class="form-field">
                <span class="form-label">تاريخ اللقاء الجديد</span>
                <app-form-control type="date" [(ngModel)]="scheduleDate" iconLeft="calendar_today" />
            </div>
            <div class="form-field">
                <span class="form-label">وقت اللقاء</span>
                <app-form-control type="time" [(ngModel)]="scheduleTime" iconLeft="schedule" />
            </div>
        </div>

        <div modal-footer class="flex justify-end gap-3 w-full">
            <app-button (click)="closeScheduleModal()" variant="ghost">إلغاء</app-button>
            <app-button (click)="saveSchedule()" variant="primary" [isLoading]="isSavingSchedule">
                تأكيد الموعد
            </app-button>
        </div>
    </app-modal>

    <!-- Loading State -->
    @if (isLoading) {
    <div class="flex-center p-xl">
        <div class="spinner-lg"></div>
    </div>
    }

    <!-- Unauthorized State -->
    @if (!isLoading && !isAuthorized) {
    <div class="chat-unauthorized">
        <h2>غير مصرح لك بالدخول</h2>
        <app-button (trigger)="goBack()">العودة</app-button>
    </div>
    }
</div>