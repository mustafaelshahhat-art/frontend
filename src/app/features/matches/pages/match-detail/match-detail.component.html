<ng-template #headerActions>
    @if (match() ; as matchData) {
    <div class="actions flex-center-gap">
        @if (matchData.status !== MatchStatus.FINISHED && matchData.status !== MatchStatus.CANCELLED) {
        <app-button
            *appHasPermission="[AppPermission.MANAGE_MATCHES, AppPermission.START_MATCH, AppPermission.MANAGE_MY_TEAM]"
            [routerLink]="getChatRoute()" variant="ghost" icon="chat" title="فتح المحادثة">
            المحادثة
        </app-button>
        }



        @if (getStatusConfig(matchData.status) ; as statusConfig) {
        <app-badge [type]="statusConfig.variant" [pulse]="matchData.status === MatchStatus.LIVE"
            [dot]="matchData.status === MatchStatus.LIVE" dotType="live">
            {{ statusConfig.label }}
        </app-badge>
        }
    </div>
    }
</ng-template>

<div class="match-detail-page">

    <!-- Loading State -->
    @if (isLoading()) {
    <div class="match-detail-loading">
        <div class="loading-content">
            <div class="loading-spinner-lg"></div>
            <p>جاري تحميل تفاصيل المباراة...</p>
        </div>
    </div>
    }

    <!-- Match Content -->
    @if (!isLoading() && match() ; as matchData) {

    <!-- Main Score Hero -->
    <div class="score-card-hero" [class.is-live]="matchData.status === MatchStatus.LIVE"
        [class.is-finished]="matchData.status === MatchStatus.FINISHED"
        [class.is-cancelled]="matchData.status === MatchStatus.CANCELLED">

        @if (matchData.status === MatchStatus.LIVE) {
        <div class="live-banner">
            <span class="pulse-dot"></span>
            مباراة جارية الآن
        </div>
        }

        <div class="score-card-content">
            <div class="team-block home clickable" [routerLink]="getTeamRoute(matchData.homeTeamId)">
                <div class="team-logo-container">
                    <app-smart-image [src]="matchData.homeTeamLogoUrl" type="team" size="md"
                        [initials]="matchData.homeTeamName.charAt(0)" />
                </div>
                <h2>{{ matchData.homeTeamName }}</h2>
                <span class="team-tag">صاحب الأرض</span>
            </div>

            <div class="score-block">
                <div class="score-numbers">
                    <span class="score home">{{ matchData.homeScore }}</span>
                    <span class="score-divider">:</span>
                    <span class="score away">{{ matchData.awayScore }}</span>
                </div>

                @if (matchData.date) {
                <div class="match-time-banner">
                    <app-icon name="calendar_today" class=" icon-sm"></app-icon>
                    موعد اللقاء: {{ matchData.date | date:'yyyy/MM/dd' }} - {{ matchData.date | date:'hh:mm a' }}
                </div>
                }


            </div>

            <div class="team-block away clickable" [routerLink]="getTeamRoute(matchData.awayTeamId)">
                <div class="team-logo-container">
                    <app-smart-image [src]="matchData.awayTeamLogoUrl" type="team" size="md"
                        [initials]="matchData.awayTeamName.charAt(0)" />
                </div>
                <h2>{{ matchData.awayTeamName }}</h2>
                <span class="team-tag">الضيف</span>
            </div>
        </div>

    </div>

    <!-- Main Grid: Controls + Events -->
    <div class="match-detail-main-grid">

        <!-- Events Column -->
        <div class="events-section">
            <div class="events-panel">
                <div class="panel-header">
                    <app-icon name="timeline" class=" icon-sm"></app-icon>
                    <h3>أحداث المباراة</h3>
                    <span class="events-badge">{{ matchData.events?.length || 0 }}</span>
                </div>

                <!-- Empty State -->
                @if (!matchData.events || matchData.events.length === 0) {
                <app-empty-state icon="sports_soccer" title="لا توجد أحداث" description="لا توجد أحداث حتى الآن" />
                }

                <!-- Events List -->
                @if (matchData.events && matchData.events.length > 0) {
                <app-match-timeline [events]="matchData.events" [homeTeamId]="matchData.homeTeamId"
                    [homeTeamName]="matchData.homeTeamName" [awayTeamName]="matchData.awayTeamName"
                    (deleteEvent)="deleteEvent($event)" />
                }
            </div>
        </div>

        <!-- Controls Column -->
        <div class="controls-section">

            <!-- Admin Controls (Premium Redesign) -->
            <div *appHasPermission="AppPermission.MANAGE_MATCHES" class="admin-tools-premium">
                <div class="admin-header">
                    <div class="admin-title">
                        <app-icon name="admin_panel_settings" class=" icon-sm"></app-icon>
                        <h3>{{ managementTitle }}</h3>
                    </div>
                    <div class="admin-badge">{{ managementModeLabel }}</div>
                </div>

                <div class="admin-content">


                    <!-- Management Grid -->
                    <div class="admin-grid-two">
                        <app-button variant="outline" icon="calendar_month" (click)="openSetScheduleModal()">
                            تحديد موعد اللقاء
                        </app-button>

                        @if (matchData.status === MatchStatus.SCHEDULED || matchData.status === MatchStatus.POSTPONED ||
                        matchData.status === MatchStatus.RESCHEDULED) {
                        <app-button variant="primary" icon="play_arrow" (click)="startMatch()">
                            بدء المباراة
                        </app-button>
                        }

                        @if (matchData.status === MatchStatus.LIVE) {
                        <app-button variant="danger" icon="stop" (click)="onEndMatchClick()">
                            إنهاء المباراة
                        </app-button>
                        }
                    </div>
                    <div class="admin-grid-full mt-3">
                        <app-button variant="outline" icon="edit_note" (click)="openEventModal()" class="w-full">
                            إدارة الأحداث
                        </app-button>
                    </div>

                    <div class="admin-divider-section">
                        <span class="admin-divider-text">حالة اللقاء</span>
                    </div>

                    <!-- Status Controls -->
                    <div class="status-grid-flex">
                        <app-button variant="outline" size="sm" icon="schedule" (click)="openPostponeModal()"
                            [disabled]="matchData.status === MatchStatus.CANCELLED" class="flex-1">تأجيل</app-button>
                        <app-button variant="outline" size="sm" icon="replay" (click)="openRescheduleModal()"
                            class="flex-1">إعادة</app-button>
                        <app-button variant="danger" size="sm" icon="cancel" (click)="openCancelModal()"
                            [disabled]="matchData.status === MatchStatus.CANCELLED" class="flex-1">
                            {{ matchData.status === MatchStatus.CANCELLED ? 'ملغاة' : 'إلغاء' }}
                        </app-button>
                    </div>
                </div>
            </div>








        </div>

    </div>

    }
</div>



<!-- Centralized End Match Confirmation Dialog -->
<app-end-match-confirm [matchId]="match()?.id || ''" [visible]="showEndMatchConfirm()"
    (visibleChange)="showEndMatchConfirm.set($event)" (matchEnded)="onMatchEnded($event)" />

<!-- Centralized Event Recording Modal -->
<app-match-event-modal [match]="match()" [visible]="showEventModal()" (visibleChange)="showEventModal.set($event)"
    (eventAdded)="onEventAdded($event)" />





<!-- Postpone/Reset Schedule Modal -->
<app-modal [visible]="showScheduleModal()"
    [title]="scheduleType === 'postpone' ? 'تأجيل المباراة' : (scheduleType === 'reset' ? 'إعادة جدولة المباراة' : 'تحديد موعد اللقاء')"
    [icon]="scheduleType === 'postpone' ? 'schedule' : (scheduleType === 'reset' ? 'restart_alt' : 'calendar_month')"
    (closeRequest)="closeScheduleModal()">

    <div class="form-grid">
        <div class="form-field">
            <span class="form-label">تاريخ اللقاء الجديد</span>
            <app-form-control type="date" [(ngModel)]="scheduleForm.date" iconLeft="calendar_today" />
        </div>
        <div class="form-field">
            <span class="form-label">وقت اللقاء</span>
            <app-form-control type="time" [(ngModel)]="scheduleForm.time" iconLeft="schedule" />
        </div>
    </div>

    <div modal-footer class="flex justify-end gap-3 w-full">
        <app-button (click)="closeScheduleModal()" variant="ghost">إلغاء</app-button>
        <app-button (click)="submitScheduleChange()" [variant]="scheduleType === 'postpone' ? 'primary' : 'outline'">
            تأكيد الموعد
        </app-button>
    </div>
</app-modal>

<!-- Cancel Match Modal -->
<app-modal [visible]="showCancelModal()" title="إلغاء المباراة نهائياً" icon="block" theme="danger"
    (closeRequest)="closeCancelModal()">
    <div class="prose mb-4">
        <p class="text-secondary">سيتم إرسال إشعار فوري لجميع اللاعبين بسبب الإلغاء.</p>
    </div>

    <div class="form-field full-width">
        <span class="form-label">سبب الإلغاء</span>
        <app-form-control type="textarea" [(ngModel)]="cancelReason" [rows]="4"
            placeholder="اكتب سبب الإلغاء هنا ليظهر للجميع..." />
    </div>

    <div modal-footer class="flex justify-end gap-3 w-full">
        <app-button (click)="closeCancelModal()" variant="ghost">تراجع</app-button>
        <app-button (click)="submitCancellation()" variant="danger">إلغاء المباراة وإخطار الجميع</app-button>
    </div>
</app-modal>