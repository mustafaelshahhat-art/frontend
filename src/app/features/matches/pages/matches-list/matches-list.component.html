<!-- Filters Template -->
<ng-template #filtersTemplate>
    @if (!isPending()) {
    <app-filter [items]="filters" [activeValue]="selectedFilter()" (filterChange)="setFilter($event)" />
    }
</ng-template>

<!-- Pending Status (Blocker) -->
@if (isPending() && !permissionsService.has(Permission.VIEW_ADMIN_DASHBOARD)) {
<app-pending-status-card title="حسابك قيد المراجعة"
    message="عذراً، لا يمكنك استعراض أو إدارة المباريات حتى يتم اعتماد حسابك من قبل إدارة البطولة. يرجى الانتظار، سيتم إخطارك فور التفعيل."
    (onRefresh)="refreshStatus()" />
} @else {
<!-- Main Content -->
<div class="flex-col gap-md">
    <!-- Loading State -->
    @if (isLoading()) {
    <app-inline-loading message="جاري تحميل المباريات..." />
    }

    <!-- Empty State -->
    @if (!isLoading() && filteredMatches().length === 0) {
    <app-empty-state icon="event_busy" title="لا توجد مباريات" [description]="emptyStateDescription" />
    }

    <!-- Matches Grid -->
    @if (!isLoading() && filteredMatches().length > 0) {
    <div class="matches-grid">
        @for (match of filteredMatches(); track match.id) {
        <app-match-card [match]="match" (click)="viewMatch(match.id)" class="clickable-match-card">

            <div class="match-card-actions" actions>
                <!-- Admin: Update Score -->
                <app-button *appHasPermission="Permission.MANAGE_MATCHES"
                    (click)="$event.stopPropagation(); updateScore(match)" size="sm" variant="outline"
                    icon="scoreboard">
                    تحديث النتيجة
                </app-button>

                <!-- Referee: Start Match -->
                @if (match.status === MatchStatus.SCHEDULED) {
                <app-button *appHasPermission="Permission.START_MATCH"
                    (click)="$event.stopPropagation(); startMatch(match)" size="sm" variant="primary" icon="play_arrow">
                    بدء المباراة
                </app-button>
                }

                <!-- Referee: Live Actions -->
                <ng-container *appHasPermission="Permission.START_MATCH">
                    @if (match.status === MatchStatus.LIVE) {
                    <div class="live-actions gap-2 w-full">
                        <button (click)="$event.stopPropagation(); openEventModal(match)"
                            class="match-card-action primary-btn flex-1">
                            <app-icon name="edit_note" class=" icon-sm"></app-icon>
                            تسجيل حدث
                        </button>
                        <button (click)="$event.stopPropagation(); onEndMatchClick(match)"
                            class="match-card-action danger-btn flex-1">
                            <app-icon name="stop_circle" class=" icon-sm"></app-icon>
                            إنهاء
                        </button>
                    </div>
                    }
                </ng-container>

                <!-- Captain/Player Actions -->
                <div *appHasPermission="Permission.CREATE_OBJECTION" class="player-actions">
                    <!-- Details Button -->
                    <button class="action-btn details-btn" (click)="$event.stopPropagation(); viewMatch(match.id)">
                        <app-icon name="info" class=" icon-sm"></app-icon>
                        <span>التفاصيل</span>
                    </button>

                    <!-- Chat Button -->
                    @if (match.status !== MatchStatus.FINISHED && match.status !== MatchStatus.CANCELLED) {
                    <button class="action-btn chat-btn" [class.chat-live]="match.status === MatchStatus.LIVE"
                        (click)="$event.stopPropagation(); openChat(match.id)">
                        <app-icon [name]=" match.status === MatchStatus.LIVE ? 'forum' :
                            'chat' " class=" icon-sm"></app-icon>
                        <span>{{ match.status === MatchStatus.LIVE ? 'المحادثة المباشرة' : 'المحادثة' }}</span>
                    </button>
                    }

                    <!-- Objection Button -->
                    @if (match.status === MatchStatus.FINISHED || match.status === MatchStatus.CANCELLED) {
                    <button class="action-btn objection-btn"
                        (click)="$event.stopPropagation(); submitObjection(match.id)">
                        <app-icon name="report" class=" icon-sm"></app-icon>
                        <span>تقديم اعتراض</span>
                    </button>
                    }
                </div>

                <!-- Referee: View Details -->
                @if (match.status === MatchStatus.FINISHED) {
                <app-button *appHasPermission="Permission.START_MATCH" variant="ghost" size="sm" icon="chevron_left">
                    التفاصيل
                </app-button>
                }
            </div>
        </app-match-card>
        }
    </div>
    }
</div>
}

<!-- Modals -->
<app-end-match-confirm [matchId]="activeMatchId || ''" [(visible)]="showEndMatchConfirm"
    (matchEnded)="onMatchEnded($event)" />

<app-match-event-modal [match]="activeMatch" [(visible)]="showEventModal" (eventAdded)="onEventAdded($event)" />

<app-objection-modal [match]="activeMatch" [(visible)]="showObjectionModal" />