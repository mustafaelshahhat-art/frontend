<div class="objections-list-page">
    <app-page-header [title]="pageTitle" [subtitle]="pageSubtitle">
        <app-button *ngIf="isCaptain() && !showForm" variant="primary" icon="add" (click)="toggleForm()">تقديم اعتراض
            جديد</app-button>

    </app-page-header>

    <div class="objections-container">
        <!-- Filters (Admin) -->
        <div *ngIf="isAdmin()" style="margin-bottom: 1rem;">
            <app-filter [items]="filters" [activeValue]="currentFilter" (change)="setFilter($event)"></app-filter>
        </div>

        <!-- Loading -->
        <div *ngIf="isLoading" style="text-align: center; padding: 4rem;">
            <div class="loading-spinner"
                style="width: 40px; height: 40px; border: 3px solid rgba(16,185,129,0.1); border-top-color: #10B981; border-radius: 50%; animation: spin 1s linear infinite; margin: 0 auto 1rem;">
            </div>
            <p style="color: #64748b;">جاري تحميل الاعتراضات...</p>
        </div>

        <!-- Custom Objection Form (Captain) -->
        <app-card *ngIf="showForm" title="تقديم اعتراض جديد" icon="gavel" style="margin-bottom: 2rem;">
            <div class="form-body" style="display: flex; flex-direction: column; gap: 1.5rem;">
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                    <app-select label="نوع الاعتراض" [options]="objectionTypeOptions" [(ngModel)]="newObjection.type"
                        placeholder="اختر نوع الاعتراض">
                    </app-select>
                    <app-form-control label="رقم المباراة" [(ngModel)]="newObjection.matchId" placeholder="مثلاً: #102">
                    </app-form-control>
                </div>
                <app-form-control type="textarea" label="وصف الاعتراض" [(ngModel)]="newObjection.description" [rows]="4"
                    placeholder="اشرح تفاصيل الاعتراض هنا...">
                </app-form-control>
                <div style="display: flex; gap: 1rem; justify-content: flex-end;">
                    <app-button variant="ghost" (click)="showForm = false">إلغاء</app-button>
                    <app-button variant="primary" icon="send" (click)="submitObjection()">إرسال الاعتراض</app-button>
                </div>
            </div>
        </app-card>

        <!-- Empty State -->
        <app-empty-state
            *ngIf="!isLoading && (isAdmin() ? filteredObjections.length === 0 : objections.length === 0) && !showForm"
            icon="gavel" [title]="isAdmin() ? 'لا توجد اعتراضات' : 'سجل الاعتراضات فارغ'"
            [description]="isAdmin() ? 'لم يتم العثور على أي اعتراضات في هذا التصنيف حالياً.' : 'لم تقم بتقديم أي اعتراضات رسمية حتى الآن.'">
        </app-empty-state>

        <!-- Admin: Table View -->
        <div *ngIf="!isLoading && isAdmin() && filteredObjections.length > 0"
            class="card p-0 overflow-hidden objections-table-card">
            <app-table [data]="filteredObjections" [columns]="columns" [loading]="isLoading">
            </app-table>

            <!-- Match Template -->
            <ng-template #matchInfo let-row="row">
                <span class="font-bold text-success text-lg">#{{ row.matchId }}</span>
            </ng-template>

            <!-- Captain Template -->
            <ng-template #captainInfo let-row="row">
                <div class="flex items-center gap-3">
                    <div
                        class="w-8 h-8 rounded-full bg-success/10 text-success flex items-center justify-center font-bold text-xs">
                        {{ row.captainName.charAt(0) }}
                    </div>
                    <span class="text-sm font-medium">{{ row.captainName }}</span>
                </div>
            </ng-template>

            <!-- Date Template -->
            <ng-template #dateInfo let-row="row">
                <span class="text-muted text-sm">{{ row.createdAt | date:'yyyy/MM/dd' }}</span>
            </ng-template>

            <!-- Status Template -->
            <ng-template #statusInfo let-row="row">
                <app-badge
                    [type]="row.status === ObjectionStatus.APPROVED ? 'success' : row.status === ObjectionStatus.REJECTED ? 'danger' : 'warning'">
                    {{ getStatusLabel(row.status) }}
                </app-badge>
            </ng-template>

            <!-- Action Template -->
            <ng-template #actionInfo let-row="row">
                <app-button variant="icon" size="sm" icon="chevron_left" [routerLink]="['/admin/objections', row.id]">
                </app-button>
            </ng-template>
        </div>

        <!-- Captain: Card View -->
        <div *ngIf="!isLoading && !isAdmin() && objections.length > 0"
            style="display: flex; flex-direction: column; gap: 1.5rem;">
            <app-card *ngFor="let objection of objections" class="objection-item-card">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                    <div style="display: flex; align-items: center; gap: 1rem;">
                        <app-badge type="neutral">{{ getTypeLabel(objection.type) }}</app-badge>
                        <h3 style="margin: 0; font-size: 1.1rem; font-weight: 700;">{{ objection.tournamentName }}</h3>
                    </div>
                    <app-badge
                        [type]="objection.status === ObjectionStatus.APPROVED ? 'success' : objection.status === ObjectionStatus.REJECTED ? 'danger' : 'warning'">
                        {{ getStatusLabel(objection.status) }}
                    </app-badge>
                </div>

                <div class="objection-description">
                    {{ objection.description }}
                </div>

                <div class="objection-meta">
                    <span><span class="material-symbols-outlined">tag</span> المباراة: #{{ objection.matchId }}</span>
                    <span><span class="material-symbols-outlined">calendar_today</span> {{ objection.createdAt |
                        date:'yyyy/MM/dd' }}</span>
                </div>

                <div *ngIf="objection.adminNotes" class="admin-response">
                    <div class="response-header">
                        <span class="material-symbols-outlined">feedback</span>
                        قرار اللجنة
                    </div>
                    <p>{{ objection.adminNotes }}</p>
                </div>
            </app-card>
        </div>
    </div>
</div>