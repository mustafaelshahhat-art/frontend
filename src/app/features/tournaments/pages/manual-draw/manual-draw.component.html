<div class="manual-draw-page">
    @if (isLoading()) {
    <div class="loading-state">
        <div class="spinner"></div>
        <p>جاري تحميل البيانات...</p>
    </div>
    } @else {

    <!-- Stats Bar -->
    <div class="stats-bar">
        <div class="stat-item">
            <app-icon name="groups" class="icon-sm"></app-icon>
            <span>إجمالي الفرق: <strong>{{ registeredTeams().length }}</strong></span>
        </div>
        <div class="stat-item">
            <app-icon name="pending" class="icon-sm"></app-icon>
            <span>غير موزعة: <strong>{{ unassignedTeams().length }}</strong></span>
        </div>
        @if (!isKnockout()) {
        <div class="stat-item">
            <app-icon name="view_module" class="icon-sm"></app-icon>
            <span>المجموعات: <strong>{{ groupAssignments().length }}</strong></span>
        </div>
        <div class="stat-item">
            <app-icon name="straighten" class="icon-sm"></app-icon>
            <span>الحد الأقصى لكل مجموعة: <strong>{{ teamsPerGroup() }}</strong></span>
        </div>
        }
    </div>

    <!-- Unassigned Teams -->
    @if (unassignedTeams().length > 0) {
    <app-card title="الفرق غير الموزعة" class="unassigned-section">
        <div class="team-grid">
            @for (team of unassignedTeams(); track trackByTeamId($index, team)) {
            <button class="team-chip" (click)="isKnockout() ? null : openGroupModal(team)"
                [disabled]="isSubmitting()">
                <span class="team-chip-name">{{ team.teamName }}</span>
                <app-icon name="add_circle" class="icon-sm assign-icon"></app-icon>
            </button>
            }
        </div>
    </app-card>
    } @else {
    <div class="all-assigned-banner">
        <app-icon name="check_circle" class="icon-lg"></app-icon>
        <p>تم توزيع جميع الفرق!</p>
    </div>
    }

    @if (!isKnockout()) {
    <!-- ─── Groups Grid ─── -->
    <div class="groups-grid">
        @for (group of groupAssignments(); track trackByGroupId($index, group)) {
        <app-card class="group-card">
            <div class="group-header" card-header>
                <h4>{{ group.name }}</h4>
                <span class="group-count" [class.full]="isGroupFull(group)">
                    {{ group.teams.length }} / {{ teamsPerGroup() }}
                </span>
            </div>
            <div class="group-teams">
                @for (team of group.teams; track trackByTeamId($index, team)) {
                <div class="group-team-item">
                    <span>{{ team.teamName }}</span>
                    <button class="remove-btn" (click)="removeFromGroup(group.id, team)"
                        [disabled]="isSubmitting()" title="إزالة الفريق">
                        <app-icon name="close" class="icon-sm"></app-icon>
                    </button>
                </div>
                } @empty {
                <div class="group-empty">
                    <app-icon name="inbox" class="icon-md text-muted"></app-icon>
                    <p>انقر على فريق لإضافته هنا</p>
                </div>
                }
            </div>
        </app-card>
        }
    </div>
    } @else {
    <!-- ─── Knockout Pairings ─── -->
    <div class="knockout-section">
        <!-- Existing pairings -->
        @for (pair of knockoutPairings(); track trackByIndex($index)) {
        <div class="pairing-row">
            <div class="team-slot home">
                <span>{{ pair.home?.teamName }}</span>
            </div>
            <div class="vs-badge">VS</div>
            <div class="team-slot away">
                <span>{{ pair.away?.teamName }}</span>
            </div>
            <button class="delete-pair" (click)="removePairing($index)" [disabled]="isSubmitting()">
                <app-icon name="delete" class="icon-sm"></app-icon>
            </button>
        </div>
        }

        <!-- Pairing builder -->
        @if (unassignedTeams().length > 0 || knockoutPendingHome() || knockoutPendingAway()) {
        <app-card title="إنشاء مواجهة جديدة">
            <div class="pairing-builder">
                <button class="slot-btn" (click)="knockoutPendingHome() ? cancelPendingSlot('home') : openKnockoutSelector('home')"
                    [disabled]="isSubmitting()">
                    @if (knockoutPendingHome()) {
                    <span>{{ knockoutPendingHome()?.teamName }}</span>
                    <app-icon name="close" class="icon-xs"></app-icon>
                    } @else {
                    <app-icon name="add" class="icon-md"></app-icon>
                    <span>اختر الفريق الأول</span>
                    }
                </button>
                <div class="vs-text">ضد</div>
                <button class="slot-btn" (click)="knockoutPendingAway() ? cancelPendingSlot('away') : openKnockoutSelector('away')"
                    [disabled]="isSubmitting()">
                    @if (knockoutPendingAway()) {
                    <span>{{ knockoutPendingAway()?.teamName }}</span>
                    <app-icon name="close" class="icon-xs"></app-icon>
                    } @else {
                    <app-icon name="add" class="icon-md"></app-icon>
                    <span>اختر الفريق الثاني</span>
                    }
                </button>
            </div>
        </app-card>
        }
    </div>
    }

    <!-- Actions -->
    <div class="draw-actions">
        <app-button variant="outline" (trigger)="cancel()">إلغاء</app-button>
        <app-button variant="primary" [disabled]="unassignedTeams().length > 0 || isSubmitting()"
            (trigger)="submitDraw()">
            {{ isSubmitting() ? 'جاري الحفظ...' : 'اعتماد القرعة وتوليد المباريات' }}
        </app-button>
    </div>

    }
</div>

<!-- ─── Group Assignment Modal ─── -->
<app-modal [visible]="showGroupModal()" title="اختيار المجموعة" icon="view_module" size="sm"
    (closeRequest)="showGroupModal.set(false)">
    @if (selectedTeamForAssignment()) {
    <div class="modal-team-header">
        <strong>{{ selectedTeamForAssignment()?.teamName }}</strong>
    </div>
    <div class="modal-group-list">
        @for (group of groupAssignments(); track group.id) {
        <button class="modal-group-option" [class.selected]="assigningGroupId() === group.id"
            [class.full]="isGroupFull(group)" [disabled]="isGroupFull(group)"
            (click)="selectGroup(group.id)">
            <span class="group-option-name">{{ group.name }}</span>
            <span class="group-option-count" [class.full]="isGroupFull(group)">
                {{ group.teams.length }} / {{ teamsPerGroup() }}
            </span>
            @if (isGroupFull(group)) {
            <app-icon name="block" class="icon-xs text-danger"></app-icon>
            } @else if (assigningGroupId() === group.id) {
            <app-icon name="check_circle" class="icon-sm text-success"></app-icon>
            }
        </button>
        }
    </div>
    }
    <div modal-footer>
        <app-button variant="outline" size="sm" (trigger)="showGroupModal.set(false)">إلغاء</app-button>
        <app-button variant="primary" size="sm" [disabled]="assigningGroupId() === null"
            (trigger)="confirmGroupAssignment()">تأكيد التعيين</app-button>
    </div>
</app-modal>

<!-- ─── Knockout Team Selector Modal ─── -->
<app-modal [visible]="showKnockoutModal()" title="اختيار فريق" icon="sports_soccer" size="sm"
    [hasFooter]="false" (closeRequest)="showKnockoutModal.set(false)">
    <div class="modal-team-list">
        @for (team of unassignedTeams(); track team.teamId) {
        <button class="modal-team-option" (click)="selectTeamForKnockout(team)">
            <span>{{ team.teamName }}</span>
        </button>
        }
    </div>
</app-modal>