<div class="tournament-detail-page">
    <div class="tournament-detail-container">
        <!-- Loading -->
        @if (isLoading()) {
        <div class="loading-state">
            <div class="spinner"></div>
            <p>جاري تحميل البيانات...</p>
        </div>
        }

        @if (!isLoading() && tournament(); as t) {
        <!-- Banner Card -->
        <app-card class="tournament-banner-card">
            <div class="banner-overlay"></div>
            <div class="tournament-header-content">
                <div class="tournament-main-info">
                    <div class="top-meta">
                        <app-badge
                            [type]="t.status === TournamentStatus.COMPLETED ? 'gold' :
                                   (t.status === TournamentStatus.REGISTRATION_OPEN ? 'success' :
                                   (t.status === TournamentStatus.WAITING_FOR_OPENING_MATCH_SELECTION ? 'warning' : 'neutral'))"
                            class="status-badge">
                            <span class="dot"></span>
                            {{ getStatusLabel(t.status) }}
                        </app-badge>
                        <span class="created-at">أنشئت في {{ t.createdAt | date:'shortDate' }}</span>
                    </div>

                    <!-- Winner Announcement -->
                    @if (t.status === TournamentStatus.COMPLETED && t.winnerTeamName) {
                    <div class="winner-announcement animate-bounce-subtle">
                        <app-icon name="emoji_events" class="trophy icon-sm"></app-icon>
                        <div class="winner-info">
                            <span>البطل المتوج</span>
                            <h3>{{ t.winnerTeamName }}</h3>
                        </div>
                    </div>
                    }

                    <h2>{{ t.name }}</h2>

                    <div class="tournament-meta">
                        <div class="meta-item">
                            <app-icon name="calendar_today" class="icon-sm"></app-icon>
                            <div class="meta-text-wrapper">
                                <span class="label">البداية</span>
                                <span class="value">{{ t.startDate | date:'yyyy/MM/dd' }}</span>
                            </div>
                        </div>
                        <div class="meta-item">
                            <app-icon name="location_on" class="icon-sm"></app-icon>
                            <div class="meta-text-wrapper">
                                <span class="label">الموقع</span>
                                <span class="value">{{ t.location || 'غير محدد' }}</span>
                            </div>
                        </div>
                        <div class="meta-item">
                            <app-icon name="payments" class="icon-sm"></app-icon>
                            <div class="meta-text-wrapper">
                                <span class="label">الاشتراك</span>
                                <span class="value">{{ t.entryFee }} ج.م</span>
                            </div>
                        </div>
                    </div>

                    <div class="banner-actions">
                        <!-- Admin Actions -->
                        <ng-container *appHasPermission="Permission.MANAGE_TOURNAMENTS">
                            @if (canEditTournament()) {
                            <app-button variant="primary" size="md" shadow="glow" icon="edit"
                                (click)="editTournament()">
                                تعديل البطولة
                            </app-button>
                            }

                            @if (canStartRegistration()) {
                            <app-button variant="gold" size="md" shadow="glow" icon="rocket_launch"
                                (click)="toggleStatus()">
                                بدء التسجيل (نشر البطولة)
                            </app-button>
                            }

                            @if (canCloseRegistration()) {
                            <app-button variant="gold" size="md" shadow="glow" icon="lock" (click)="toggleStatus()">
                                إغلاق التسجيل
                            </app-button>
                            }

                            @if (canGenerateSchedule()) {
                            <app-button variant="primary" size="md" shadow="glow" icon="schedule"
                                (click)="generateMatches()" [disabled]="isGeneratingMatches()">
                                {{ isGeneratingMatches() ? 'جاري التوليد...' : 'توليد الجدول' }}
                            </app-button>
                            }

                            @if (canGenerateMatches()) {
                            <app-button variant="outline" size="md" icon="warning" class="emergency-action"
                                (click)="generateMatches()" [disabled]="isGeneratingMatches()">
                                {{ isGeneratingMatches() ? 'جاري التوليد...' : '⚠️ توليد يدوي للمباريات' }}
                            </app-button>
                            }

                            @if (canStartTournament()) {
                            <app-button variant="primary" size="md" shadow="glow" icon="play_arrow"
                                (click)="startTournament()">
                                بدء البطولة
                            </app-button>
                            }

                            @if (canManageDraw() && isManualMode() && tournamentMatches().length === 0) {
                            <app-button variant="gold" size="md" shadow="glow" icon="edit_calendar"
                                (click)="startManualDraw()">
                                {{ (t.format === 'KnockoutOnly' || t.format === 'KnockoutHomeAway') ? 'تحديد مواجهات
                                الإقصائيات' : 'توزيع المجموعات والجدولة' }}
                            </app-button>
                            }

                            @if (canSelectOpeningMatch()) {
                            <app-button [variant]="(t.openingTeamAId || t.openingMatchHomeTeamId) ? 'gold' : 'primary'"
                                size="md" shadow="glow" icon="star" (click)="selectOpeningMatch()">
                                {{ (t.openingTeamAId || t.openingMatchHomeTeamId) ? 'تغيير مباراة الافتتاح' : 'تحديد
                                مباراة الافتتاح' }}
                            </app-button>
                            }

                            <!-- Reset Schedule -->
                            @if (canResetSchedule()) {
                            <app-button variant="outline" size="md" icon="restart_alt"
                                (click)="resetSchedule()">
                                إعادة تعيين الجدولة
                            </app-button>
                            }

                            <app-button variant="ghost" size="md" icon="delete" class="text-danger"
                                (click)="deleteTournament()">
                                حذف البطولة
                            </app-button>

                            <!-- Emergency Overrides -->
                            @if (t.requiresAdminIntervention) {
                            @if ((t.status === TournamentStatus.REGISTRATION_CLOSED || t.status ===
                            TournamentStatus.DRAFT) && tournamentMatches().length > 0) {
                            <app-button variant="outline" size="md" icon="warning" class="emergency-action"
                                (click)="emergencyStart()">
                                ⚠️ بدء طوارئ (Admin Override)
                            </app-button>
                            }
                            @if (t.status === TournamentStatus.ACTIVE && tournamentMatches().length > 0) {
                            <app-button variant="outline" size="md" icon="warning" class="emergency-action"
                                (click)="emergencyEnd()">
                                ⚠️ إنهاء طوارئ (Admin Override)
                            </app-button>
                            }
                            }
                        </ng-container>

                        <!-- Captain Actions -->
                        <div *appHasPermission="Permission.REGISTER_TOURNAMENT">
                            @if (t.status === TournamentStatus.REGISTRATION_OPEN) {
                            <div class="captain-actions-container">
                                @if (!isRegistered() && isCaptain()) {
                                <app-button variant="primary" size="md" shadow="glow" icon="rocket_launch"
                                    (click)="registerTeam()" [disabled]="isUserPending()"
                                    [title]="isUserPending() ? 'يجب تفعيل حسابك لتتمكن من التسجيل' : ''">
                                    {{ (myRegistration()?.status ===
                                    RegistrationStatus.REJECTED ? 'سجل مرة أخرى' : 'سجل فريقك الآن') }}
                                </app-button>
                                }

                                @if (isRegistered()) {
                                <div class="registration-status-wrapper">
                                    <div class="registration-status-info">
                                        <app-icon name="check_circle" class="text-success icon-sm"></app-icon>
                                        <span>فريقك مسجل ({{ getRegStatusLabel(myRegistration()?.status || '') }})</span>

                                        @if (t.status === TournamentStatus.REGISTRATION_OPEN || t.status ===
                                        TournamentStatus.REGISTRATION_CLOSED) {
                                        <app-button variant="ghost" size="sm" class="text-danger"
                                            (click)="withdrawTeam()">
                                            انسحاب
                                        </app-button>
                                        }
                                    </div>

                                    @if (myRegistration()?.status === RegistrationStatus.PENDING_PAYMENT_REVIEW) {
                                    <div class="review-banner animate-pulse-subtle">
                                        <app-icon name="info" class="icon-sm"></app-icon>
                                        <p>طلبك قيد المراجعة من قبل الإدارة. أنت مسجل مؤقتاً في البطولة.</p>
                                    </div>
                                    }
                                </div>
                                }

                                @if (isUserPending()) {
                                <p class="pending-hint">
                                    <app-icon name="info" class="icon-sm"></app-icon>
                                    يجب تفعيل حسابك لتتمكن من التسجيل
                                </p>
                                }
                            </div>
                            }
                        </div>
                    </div>

                    <div class="tournament-quick-stats">
                        <div class="stat-circle">
                            <div class="stat-content">
                                <span class="stat-value">{{ t.currentTeams }}/{{ t.maxTeams }}</span>
                                <span class="stat-label">فريق</span>
                            </div>
                            <svg viewBox="0 0 100 100">
                                <circle cx="50" cy="50" r="45" class="bg" />
                                <circle cx="50" cy="50" r="45" class="fg" />
                            </svg>
                        </div>
                        <div class="stat-pill">
                            <app-icon name="sports_soccer" class="icon-sm"></app-icon>
                            <span class="value">{{ tournamentMatches().length }}</span>
                            <span class="label">مباراة</span>
                        </div>
                    </div>
                </div>
            </div>
        </app-card>

        <!-- ─── Sticky Navigation Filter ─── -->
        <app-filter [items]="tabs()" [activeValue]="activeTab()" (filterChange)="onTabChange($event)"
            class="tab-filter" />

        <!-- ─── Tab Content (conditional render based on mode) ─── -->
        <div class="tab-content">
            @switch (activeTab()) {
                @case ('info') {
                    <app-info-tab />
                }
                @case ('standings') {
                    @if (showStandings()) {
                        <app-standings-tab />
                    }
                }
                @case ('bracket') {
                    @if (showBracket()) {
                        <app-bracket-tab />
                    }
                }
                @case ('matches') {
                    <app-matches-tab />
                }
                @case ('teams') {
                    <app-teams-tab />
                }
            }
        </div>
        }
    </div>
</div>

<!-- Registration Modal -->
<app-team-registration-modal [tournament]="tournament()!" [isVisible]="isRegisterModalVisible()"
    (closeEvent)="closeRegisterModal()" (successEvent)="onRegistrationSuccess()" />

<!-- Opening Match Modal -->
@if (canSelectOpeningMatch() && tournament()) {
<app-opening-match-modal [tournament]="tournament()!" [isVisible]="isOpeningMatchModalVisible()"
    (close)="closeOpeningMatchModal()" (submit)="onOpeningMatchSelected($event)" />
}
