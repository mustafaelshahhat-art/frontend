<div class="tournament-detail-page">
    <app-page-header [title]="tournament?.name || 'تفاصيل البطولة'" [subtitle]="tournament?.description || ''"
        [showBack]="true">
    </app-page-header>

    <div class="tournament-detail-container">
        <!-- Loading -->
        <div *ngIf="isLoading" class="loading-state">
            <div class="spinner"></div>
            <p>جاري تحميل البيانات...</p>
        </div>

        <ng-container *ngIf="!isLoading && tournament">
            <!-- Banner Card -->
            <app-card class="tournament-banner-card">
                <div class="banner-overlay"></div>
                <div class="tournament-header-content">
                    <div class="tournament-main-info">
                        <div class="top-meta">
                            <app-badge
                                [type]="tournament.status === TournamentStatus.REGISTRATION_OPEN ? 'success' : 'neutral'"
                                class="status-badge">
                                <span class="dot"></span>
                                {{ getStatusLabel(tournament.status) }}
                            </app-badge>
                            <span class="created-at">أنشئت في {{ tournament.createdAt | date:'shortDate' }}</span>
                        </div>

                        <h2>{{ tournament.name }}</h2>

                        <div class="tournament-meta">
                            <div class="meta-item">
                                <span class="material-symbols-outlined">calendar_today</span>
                                <div>
                                    <label>البداية</label>
                                    <span>{{ tournament.startDate | date:'yyyy/MM/dd' }}</span>
                                </div>
                            </div>
                            <div class="meta-item">
                                <span class="material-symbols-outlined">location_on</span>
                                <div>
                                    <label>الموقع</label>
                                    <span>{{ tournament.location || 'غير محدد' }}</span>
                                </div>
                            </div>
                            <div class="meta-item">
                                <span class="material-symbols-outlined">payments</span>
                                <div>
                                    <label>الاشتراك</label>
                                    <span>{{ tournament.entryFee }} ريال</span>
                                </div>
                            </div>
                        </div>

                        <div class="banner-actions">
                            <!-- Admin Actions -->
                            <ng-container *ngIf="isAdmin()">
                                <app-button variant="primary" size="md" shadow="glow"
                                    [icon]="tournament.status === TournamentStatus.REGISTRATION_OPEN ? 'lock' : 'lock_open'"
                                    (click)="toggleStatus()">
                                    {{ tournament.status === TournamentStatus.REGISTRATION_OPEN ? 'إغلاق التسجيل' : 'فتح
                                    التسجيل' }}
                                </app-button>
                                
                                <!-- Generate Matches Button -->
                                <app-button *ngIf="canGenerateMatches" variant="outline" size="md" icon="calendar_month"
                                    (click)="generateMatches()" [disabled]="isGeneratingMatches">
                                    {{ isGeneratingMatches ? 'جاري التوليد...' : 'توليد جدول المباريات' }}
                                </app-button>
                            </ng-container>

                            <!-- Captain Actions -->
                            <div class="captain-actions-container"
                                *ngIf="isCaptain() && tournament.status === TournamentStatus.REGISTRATION_OPEN">
                                <ng-container *ngIf="!isRegistered">
                                    <app-button variant="primary" size="md" shadow="glow" icon="rocket_launch"
                                        (click)="registerTeam()" [disabled]="isUserPending || isBusyElsewhere"
                                        [title]="isUserPending ? 'يجب تفعيل حسابك لتتمكن من التسجيل' : isBusyElsewhere ? 'فريقك مسجل بالفعل في بطولة أخرى' : ''">
                                        {{ isBusyElsewhere ? 'مسجل في بطولة أخرى' : (myRegistration?.status ===
                                        RegistrationStatus.REJECTED ? 'سجل مرة أخرى' : 'سجل فريقك الآن') }}
                                    </app-button>
                                </ng-container>

                                <div *ngIf="isRegistered" class="registration-status-wrapper">
                                    <div class="registration-status-info">
                                        <span class="material-symbols-outlined text-success">check_circle</span>
                                        <span>فريقك مسجل ({{ getRegStatusLabel(myRegistration.status) }})</span>
                                    </div>

                                    <!-- Temporary Registration Banner -->
                                    <div *ngIf="myRegistration.status === RegistrationStatus.PENDING_PAYMENT_REVIEW"
                                        class="review-banner animate-pulse-subtle">
                                        <span class="material-symbols-outlined">info</span>
                                        <p>طلبك قيد المراجعة من قبل الإدارة. أنت مسجل مؤقتاً في البطولة.</p>
                                    </div>
                                </div>

                                <p *ngIf="isUserPending" class="pending-hint">
                                    <span class="material-symbols-outlined">info</span>
                                    يجب تفعيل حسابك لتتمكن من التسجيل
                                </p>
                                <p *ngIf="isBusyElsewhere && !isRegistered" class="pending-hint">
                                    <span class="material-symbols-outlined">info</span>
                                    لا يمكنك التسجيل في أكثر من بطولة نشطة في نفس الوقت
                                </p>
                            </div>
                        </div>
                    </div>

                    <div class="tournament-quick-stats">
                        <div class="stat-circle"
                            [style.--progress]="(tournament.currentTeams / tournament.maxTeams) * 100">
                            <div class="stat-content">
                                <span class="stat-value">{{ tournament.currentTeams }}/{{ tournament.maxTeams }}</span>
                                <span class="stat-label">فريق</span>
                            </div>
                            <svg viewBox="0 0 100 100">
                                <circle cx="50" cy="50" r="45" class="bg"></circle>
                                <circle cx="50" cy="50" r="45" class="fg"></circle>
                            </svg>
                        </div>
                        <div class="stat-pill">
                            <span class="material-symbols-outlined">sports_soccer</span>
                            <span class="value">{{ matches.length }}</span>
                            <span class="label">مباراة</span>
                        </div>
                    </div>
                </div>
            </app-card>

            <!-- Navigation Tabs -->
            <app-filter [items]="tabs" [activeValue]="activeTab" (change)="activeTab = $event"
                class="tab-filter"></app-filter>

            <!-- Navigation Tabs Content -->
            <div class="tab-content" [ngSwitch]="activeTab">
                <!-- Info Tab -->
                <div *ngSwitchCase="'info'" class="info-grid">
                    <app-card class="stats-card">
                        <div class="card-header-premium">
                            <span class="material-symbols-outlined">military_tech</span>
                            <h3>الهدافون</h3>
                        </div>
                        <div class="scorers-list">
                            <div *ngFor="let s of scorers" class="scorer-item">
                                <div class="rank">{{ s.rank }}</div>
                                <div class="info">
                                    <span class="name">{{ s.name }}</span>
                                    <span class="team">{{ s.team }}</span>
                                </div>
                                <div class="goals-badge">
                                    <span class="value">{{ s.goals }}</span>
                                    <span class="label">أهداف</span>
                                </div>
                            </div>
                        </div>
                    </app-card>

                    <app-card class="rules-card">
                        <div class="card-header-premium">
                            <span class="material-symbols-outlined">gavel</span>
                            <h3>قواعد البطولة</h3>
                        </div>
                        <div class="rules-list">
                            <div class="rule-item">
                                <span class="material-symbols-outlined check">check_circle</span>
                                <p>الالتزام بالزي الرياضي الموحد لجميع أعضاء الفريق.</p>
                            </div>
                            <div class="rule-item">
                                <span class="material-symbols-outlined check">check_circle</span>
                                <p>الحضور قبل موعد المباراة بـ 15 دقيقة على الأقل.</p>
                            </div>
                            <div class="rule-item">
                                <span class="material-symbols-outlined check">check_circle</span>
                                <p>يمنع الاعتراض غير اللائق على قرارات الحكام.</p>
                            </div>
                        </div>
                    </app-card>
                </div>

                <!-- Standings Tab -->
                <div *ngSwitchCase="'standings'" class="standings-wrapper">
                    <!-- Desktop Table -->
                    <div class="desktop-only">
                        <table>
                            <thead>
                                <tr>
                                    <th class="rank">#</th>
                                    <th class="team-name">الفريق</th>
                                    <th>لعب</th>
                                    <th>فاز</th>
                                    <th>تعادل</th>
                                    <th>خسر</th>
                                    <th>+/-</th>
                                    <th class="points">نقاط</th>
                                    <th style="text-align: center;">آخر 5</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr *ngFor="let s of standings; let i = index">
                                    <td class="rank">{{ i + 1 }}</td>
                                    <td class="team-name">{{ s.team }}</td>
                                    <td>{{ s.played }}</td>
                                    <td>{{ s.won }}</td>
                                    <td>{{ s.draw }}</td>
                                    <td>{{ s.lost }}</td>
                                    <td>{{ s.gd }}</td>
                                    <td class="points">{{ s.points }}</td>
                                    <td style="text-align: center;">
                                        <div style="display: flex; gap: 4px; justify-content: center;">
                                            <span *ngFor="let r of s.form" class="form-dot" [class]="r">{{ r }}</span>
                                        </div>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>

                    <!-- Mobile Shared Grid Design -->
                    <div class="mobile-data-grid">
                        <div *ngFor="let s of standings; let i = index" class="mobile-data-card">
                            <div class="card-mobile-header">
                                <div class="title-group">
                                    <div class="rank-badge">{{ i + 1 }}</div>
                                    <h4>{{ s.team }}</h4>
                                </div>
                                <app-badge type="success">{{ s.points }} نقطة</app-badge>
                            </div>

                            <div class="card-mobile-stats">
                                <div class="stat-box"><span class="label">لعب</span><span class="value">{{ s.played
                                        }}</span></div>
                                <div class="stat-box highlight"><span class="label">فاز</span><span class="value">{{
                                        s.won }}</span></div>
                                <div class="stat-box"><span class="label">تعادل</span><span class="value">{{ s.draw
                                        }}</span></div>
                                <div class="stat-box"><span class="label">خسر</span><span class="value">{{ s.lost
                                        }}</span></div>
                                <div class="stat-box"><span class="label">+/-</span><span class="value">{{ s.gd
                                        }}</span></div>
                                <div class="stat-box highlight"><span class="label">نقاط</span><span class="value">{{
                                        s.points }}</span></div>
                            </div>

                            <div class="card-mobile-footer">
                                <span class="footer-label">آخر 5 مباريات:</span>
                                <div class="footer-content">
                                    <span *ngFor="let r of s.form" class="form-dot" [class]="r">{{ r }}</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Matches Tab -->
                <div *ngSwitchCase="'matches'">
                    <div *ngIf="matches.length > 0" class="matches-grid">
                        <app-match-card *ngFor="let match of matches" [match]="match" (click)="viewMatch(match.id)"
                            style="cursor: pointer;"></app-match-card>
                    </div>
                    <app-empty-state *ngIf="matches.length === 0" icon="event_busy" title="لا توجد مباريات"
                        description="لم يتم جدولة أي مباريات لهذه البطولة حتى الآن.">
                    </app-empty-state>
                </div>

                <!-- Teams Tab -->
                <div *ngSwitchCase="'teams'" class="teams-grid">
                    <div *ngFor="let reg of tournament.registrations" class="team-card">
                        <div class="team-logo">
                            <span class="material-symbols-outlined">shield</span>
                        </div>
                        <div class="team-info">
                            <h3>{{ reg.teamName }}</h3>
                            <div class="captain-info">
                                <span class="material-symbols-outlined">person</span>
                                <span>{{ reg.captainName }}</span>
                            </div>
                        </div>
                        <div class="team-footer">
                            <span class="date">مسجل: {{ reg.registeredAt | date:'yyyy/MM/dd' }}</span>
                            <app-badge [type]="getRegStatusType(reg.status)" size="sm">
                                {{ getRegStatusLabel(reg.status) }}
                            </app-badge>
                        </div>
                    </div>
                    <app-empty-state *ngIf="!tournament.registrations || tournament.registrations.length === 0"
                        icon="groups" title="لا يوجد فرق" description="لم يتم تسجيل أي فرق في هذه البطولة حالياً.">
                    </app-empty-state>
                </div>
            </div>
        </ng-container>
    </div>
</div>

<!-- Registration Modal -->
<div *ngIf="isRegisterModalVisible" class="modal-overlay" (click)="closeRegisterModal()"
    style="position: fixed; inset: 0; background: rgba(0,0,0,0.8); backdrop-filter: blur(8px); display: flex; align-items: center; justify-content: center; z-index: 1000; padding: 1.5rem;">
    <app-card class="modal-box" (click)="$event.stopPropagation()" style="width: 100%; max-width: 500px;"
        title="تسجيل الفريق" icon="rocket_launch">
        <div class="form-body" style="display: flex; flex-direction: column; gap: 1.5rem;">
            <div class="form-group">
                <label style="display: block; margin-bottom: 0.5rem; color: #94a3b8; font-size: 0.875rem;">الرقم المحول
                    منه</label>
                <input type="text" [(ngModel)]="registerForm.fromNumber" class="premium-input"
                    placeholder="رقم الجوال المحول منه">
            </div>

            <div class="form-group">
                <label style="display: block; margin-bottom: 0.5rem; color: #94a3b8; font-size: 0.875rem;">نوع
                    التحويل</label>
                <select [(ngModel)]="registerForm.transferType" class="premium-input">
                    <option value="">اختر النوع</option>
                    <option value="STC Pay">STC Pay</option>
                    <option value="Urpay">Urpay</option>
                    <option value="Bank Transfer">تحويل بنكي</option>
                </select>
            </div>

            <div class="form-group">
                <label style="display: block; margin-bottom: 0.5rem; color: #94a3b8; font-size: 0.875rem;">إيصال
                    الدفع</label>
                <div (click)="fileInput.click()"
                    style="border: 2px dashed rgba(255,255,255,0.1); border-radius: 12px; padding: 2rem; text-align: center; cursor: pointer; transition: all 0.3s; background: rgba(255,255,255,0.02);"
                    onmouseover="this.style.borderColor='#10B981'; this.style.background='rgba(16,185,129,0.05)'"
                    onmouseout="this.style.borderColor='rgba(255,255,255,0.1)'; this.style.background='rgba(255,255,255,0.02)'">
                    <input #fileInput type="file" (change)="onFileSelected($event)" hidden accept="image/*">
                    <span class="material-symbols-outlined"
                        style="font-size: 2.5rem; color: #10B981; margin-bottom: 0.5rem;">cloud_upload</span>
                    <p style="margin: 0; color: #94a3b8;">{{ registerForm.receipt ? registerForm.receipt.name : 'اسحب
                        الإيصال هنا أو انقر للإرفاق' }}</p>
                </div>
            </div>
        </div>

        <div style="margin-top: 2rem; display: flex; gap: 1rem; justify-content: flex-end;">
            <app-button variant="ghost" (click)="closeRegisterModal()">إلغاء</app-button>
            <app-button variant="primary" icon="send" (click)="submitRegistration()" [isLoading]="isSubmitting"
                [disabled]="!registerForm.fromNumber || !registerForm.transferType || !registerForm.receipt">إرسال
                الطلب</app-button>
        </div>
    </app-card>
</div>