<ng-template #actionsTemplate>
    <div class="action-buttons-wrapper flex items-center gap-3">
        @if (!isPending()) {
        <app-button (trigger)="toggleEditMode()" [isLoading]="isLoading()" [icon]="isEditing() ? 'save' : 'edit'"
            [disabled]="isLoading() || (isEditing() && !hasChanges)">
            {{ saveButtonLabel() }}
        </app-button>
        }
    </div>
</ng-template>

<div class="profile-page">

    <!-- Pending Status - Replace content when pending -->
    @if (isPending()) {
    <app-pending-status-card title="حسابك قيد المراجعة"
        message="عذراً، لا يمكنك الوصول لإعدادات الحساب حتى يتم اعتماد حسابك من قبل إدارة البطولة. يرجى الانتظار، سيتم إخطارك فور التفعيل."
        (refreshRequest)="refreshStatus()" />
    } @else {
    <!-- Main Content (only when not pending) -->
    <div class="profile-nav-wrapper">
        <app-filter
            [items]="[ {label: 'المعلومات الشخصية', value: 'info', icon: 'person'}, {label: 'كلمة المرور', value: 'password', icon: 'lock'} ]"
            [activeValue]="activeSection()" (filterChange)="setActiveSection($event)" />
    </div>

    <div class="profile-container">
        <!-- Sidebar -->
        <div class="profile-sidebar">
            <app-card class="avatar-card">
                <div class="avatar-wrapper">
                    <div class="user-initial-badge user-initial-badge--2xl" [attr.data-user-id]="user()?.id">
                      <app-icon name="person" class="badge-icon"></app-icon>
                    </div>
                </div>
                <h2>{{ user()?.name }}</h2>
                <span class="username">@{{ user()?.email?.split('@')?.[0] }}</span>

                <div class="membership-card">
                    <p class="membership-label">معرف العضوية</p>
                    <p class="membership-id">{{ displayId() || user()?.displayId }}</p>
                </div>
            </app-card>
        </div>

        <!-- Content Area -->
        <div class="profile-content">
            <!-- Edit Info Section -->
            @if (activeSection() === 'info' && profileForm) {
            <app-card title="المعلومات الشخصية" icon="settings_account_box">
                <form [formGroup]="profileForm" (ngSubmit)="toggleEditMode()">
                    <div class="form-grid">
                        <div class="form-group full-width">
                            <app-form-control formControlName="name" label="الاسم الكامل"
                                [control]="profileForm.get('name')" />
                        </div>

                        <div class="form-group">
                            <app-form-control formControlName="email" label="البريد الإلكتروني" type="email"
                                [control]="profileForm.get('email')" />
                        </div>

                        <div class="form-group">
                            <app-form-control formControlName="phone" label="رقم الجوال" placeholder="05XXXXXXXX"
                                type="tel" [control]="profileForm.get('phone')" />
                        </div>

                        <div class="form-group">
                            <app-form-control formControlName="username" label="اسم المستخدم"
                                [control]="profileForm.get('username')" />
                        </div>

                        <div class="form-group">
                            <app-form-control formControlName="nationalId" label="رقم الهوية (محمي)"
                                [control]="profileForm.get('nationalId')" />
                        </div>

                        <div class="form-group">
                            <app-select [options]="facade.governorateOptions()" formControlName="governorateId"
                                (selectionChange)="onGovernorateChange($event)" label="المحافظة"
                                placeholder="اختر المحافظة" />
                        </div>

                        <div class="form-group">
                            <app-select [options]="facade.cityOptions()" formControlName="cityId"
                                (selectionChange)="onCityChange($event)" label="المدينة" placeholder="اختر المدينة"
                                [loading]="facade.isLoadingCities()" />
                        </div>

                        <div class="form-group">
                            <app-select [options]="facade.districtOptions()" formControlName="areaId"
                                (selectionChange)="onDistrictChange($event)" label="الحي" placeholder="اختر الحي"
                                [loading]="facade.isLoadingAreas()" />
                        </div>
                    </div>

                    <!-- Cancel button only (Save is in layout header) -->
                    @if (isEditing()) {
                    <div class="form-actions">
                        <app-button type="button" (trigger)="cancelEdit()" variant="outline" icon="close">
                            إلغاء التعديل
                        </app-button>
                    </div>
                    }
                </form>
            </app-card>
            }

            <!-- Change Password Section -->
            @if (activeSection() === 'password' && passwordForm) {
            <app-card title="تغيير كلمة المرور" icon="key">
                <form [formGroup]="passwordForm" (ngSubmit)="updatePassword()">
                    <div class="password-form-container">
                        <div class="form-group">
                            <app-form-control formControlName="currentPassword" label="كلمة المرور الحالية"
                                type="password" placeholder="أدخل كلمة المرور الحالية"
                                [control]="passwordForm.get('currentPassword')" />
                        </div>

                        <div class="form-group">
                            <app-form-control formControlName="newPassword" label="كلمة المرور الجديدة" type="password"
                                placeholder="6 أحرف على الأقل" [control]="passwordForm.get('newPassword')" />
                        </div>

                        <div class="form-group">
                            <app-form-control formControlName="confirmPassword" label="تأكيد كلمة المرور الجديدة"
                                type="password" placeholder="أعد إدخال كلمة المرور"
                                [control]="passwordForm.get('confirmPassword')" />
                        </div>
                    </div>

                    <div class="form-actions">
                        <app-button type="submit" variant="primary" [isLoading]="isPasswordLoading()" icon="lock_reset"
                            [disabled]="passwordForm.invalid">
                            تحديث كلمة المرور
                        </app-button>
                    </div>
                </form>
            </app-card>
            }
        </div>
    </div>
    }
</div>