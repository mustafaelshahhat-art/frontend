<div class="page-container user-detail-page">
    <div class="page-content">

        <!-- Loading State -->
        @if (isLoading) {
        <app-inline-loading message="جاري تحميل بيانات المستخدم..." />
        }

        <!-- Error/Not Found State -->
        @if (!isLoading && !user) {
        <app-empty-state icon="person_off" title="لم يتم العثور على المستخدم"
            description="قد يكون المستخدم غير موجود أو تم حذفه">
            <app-button (click)="navigateBack()">العودة لقائمة المستخدمين</app-button>
        </app-empty-state>
        }

        <!-- User Data Content -->
        @if (!isLoading && user) {
        <ng-container>
            <!-- Hero Section with User Profile -->
            <div class="user-hero animate-fade-in">
                <div class="hero-backdrop"></div>
                <div class="hero-content">
                    <!-- Profile Card -->
                    <div class="profile-card">
                        <div class="profile-avatar">
                            <div class="user-initial-badge user-initial-badge--xl" [attr.data-user-id]="user.id">
                              <app-icon name="person" class="badge-icon"></app-icon>
                            </div>
                            <div class="status-indicator" [class.active]="user.status === 'Active'"
                                [class.inactive]="user.status !== 'Active'">
                                <app-icon [name]="user.status === 'Active' ? 'check_circle' : 'cancel' "
                                    class=" icon-sm"></app-icon>
                            </div>
                        </div>

                        <div class="profile-info">
                            <div class="profile-meta">
                                <app-badge type="gold">
                                    <app-icon name="military_tech" class=" icon-sm"></app-icon>
                                    {{ getRoleLabel(user.role) }}
                                </app-badge>
                                <app-badge [type]="getBadgeType(user.status)">
                                    {{ getStatusLabel(user.status) }}
                                </app-badge>
                            </div>
                        </div>

                        @if (!isLastAdmin() || user.status !== 'Active') {
                        <div class="profile-actions">
                            <app-button (click)="toggleUserStatus()"
                                [variant]="user.status === 'Active' ? 'danger' : 'primary'"
                                [icon]="user.status === 'Active' ? 'block' : 'check_circle'" size="lg">
                                {{ user.status === 'Active' ? 'تعطيل الحساب' : 'تفعيل الحساب' }}
                            </app-button>
                        </div>
                        }
                    </div>
                </div>
            </div>

            <!-- Content Grid -->
            <div class="content-grid">
                <!-- Quick Stats Row -->
                <div class="stats-row animate-fade-in-up">
                    <app-stat-card label="معرف العضوية" [value]="user.displayId" icon="fingerprint" />
                    <app-stat-card label="رقم الهوية" [value]="user.nationalId || '—'" icon="badge" />
                    <app-stat-card label="العمر" [value]="(user.age || '—') + ' سنة'" icon="cake" />
                    <app-stat-card label="الهاتف" [value]="user.phone || '—'" icon="call" />
                </div>

                <!-- Main Content Columns -->
                <div class="main-columns">
                    <!-- Left Column: Activity & Location -->
                    <div class="column-left">
                        <!-- Activity Timeline -->
                        <div class="glass-card animate-fade-in-up animate-delay-100">
                            <div class="card-header">
                                <div class="card-icon">
                                    <app-icon name="history" class=" icon-sm"></app-icon>
                                </div>
                                <h2 class="card-title">سجل النشاط</h2>
                                @if (user.activities?.length) {
                                <span class="activity-count">
                                    {{ user.activities?.length }}
                                </span>
                                }
                            </div>

                            @if (user.activities && user.activities.length > 0) {
                            <div class="timeline">
                                @for (activity of user.activities; track $index; let i = $index; let last = $last) {
                                <!-- eslint-disable-next-line @angular-eslint/template/no-inline-styles -->
                                <div class="timeline-item" [style.animation-delay]="(i * 0.05) + 's'">
                                    <div class="timeline-dot" [ngClass]="getActivityBadgeClass(activity.type)">
                                        <app-icon [name]="getActivityIcon(activity.type) " class=" icon-sm"></app-icon>
                                    </div>
                                    @if (!last) {
                                    <div class="timeline-connector"></div>
                                    }
                                    <div class="timeline-content">
                                        <p class="timeline-message">{{ activity.message }}</p>
                                        <span class="timeline-time">
                                            <app-icon name="schedule" class=" icon-sm"></app-icon>
                                            {{ activity.createdAt | date:'yyyy/MM/dd - HH:mm' }}
                                        </span>
                                    </div>
                                </div>
                                }
                            </div>
                            }

                            @if (!user.activities?.length) {
                            <div class="empty-timeline">
                                <app-icon name="history_toggle_off" class=" icon-sm"></app-icon>
                                <p>لا يوجد نشاط مسجل حالياً</p>
                            </div>
                            }
                        </div>
                    </div>

                    <!-- Right Column: Info & Documents -->
                    <div class="column-right">
                        <!-- Location Card -->
                        <div class="glass-card animate-fade-in-up animate-delay-150">
                            <div class="card-header">
                                <div class="card-icon">
                                    <app-icon name="location_on" class=" icon-sm"></app-icon>
                                </div>
                                <h2 class="card-title">العنوان</h2>
                            </div>
                            <div class="location-grid">
                                <div class="location-item">
                                    <span class="location-label">المحافظة</span>
                                    <span class="location-value">{{ user.governorateNameAr || '—' }}</span>
                                </div>
                                <div class="location-item">
                                    <span class="location-label">المدينة</span>
                                    <span class="location-value">{{ user.cityNameAr || '—' }}</span>
                                </div>
                                <div class="location-item full">
                                    <span class="location-label">الحي</span>
                                    <span class="location-value">{{ user.areaNameAr || '—' }}</span>
                                </div>
                            </div>
                        </div>

                        <div class="glass-card animate-fade-in-up animate-delay-200">
                            <div class="card-header">
                                <div class="card-icon">
                                    <app-icon name="verified_user" class=" icon-sm"></app-icon>
                                </div>
                                <h2 class="card-title">وثائق الهوية</h2>
                            </div>
                            <div class="documents-gallery">
                                <div class="doc-card">
                                    <div class="doc-label">
                                        <app-icon name="credit_card" class=" icon-sm"></app-icon>
                                        <span>وجه البطاقة</span>
                                    </div>
                                    <div class="doc-image cursor-pointer hover:opacity-90 transition-opacity"
                                        (click)="openImage(user.idFrontUrl)">
                                        <app-smart-image [src]="user.idFrontUrl" type="id" size="custom" />
                                        <div class="doc-overlay">
                                            <app-icon name="zoom_in"
                                                class=" icon-sm text-white drop-shadow-md"></app-icon>
                                        </div>
                                    </div>
                                </div>
                                <div class="doc-card">
                                    <div class="doc-label">
                                        <app-icon name="credit_card" class=" icon-sm"></app-icon>
                                        <span>ظهر البطاقة</span>
                                    </div>
                                    <div class="doc-image cursor-pointer hover:opacity-90 transition-opacity"
                                        (click)="openImage(user.idBackUrl)">
                                        <app-smart-image [src]="user.idBackUrl" type="id" size="custom" />
                                        <div class="doc-overlay">
                                            <app-icon name="zoom_in"
                                                class=" icon-sm text-white drop-shadow-md"></app-icon>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </ng-container>
        }
    </div>

    <!-- Image Viewer Modal -->
    @if (selectedImage()) {
    <div class="image-viewer-overlay" (click)="closeImage()">

        <button class="viewer-close-btn" (click)="closeImage()">
            <app-icon name="close" class="icon-md"></app-icon>
        </button>

        <div class="viewer-content" (click)="$event.stopPropagation()">
            <app-smart-image [src]="selectedImage()" type="id" size="custom" />
        </div>
    </div>
    }
</div>