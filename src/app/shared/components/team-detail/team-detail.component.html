<div class="page-container animate-fade-in">
    <div class="page-content flex-col gap-lg">


        <!-- Team Identity Hero -->
        <div class="card p-0 relative overflow-hidden">
            <!-- Glass Header Background -->
            <div class="absolute inset-0 bg-gradient-to-r from-primary to-transparent opacity-5"></div>

            <div class="flex items-center gap-xl p-lg flex-wrap mobile-center relative">
                <!-- Team Logo Square (Premium) -->
                <div class="shadow-glow-sm border-4 border-surface-light rounded-xl overflow-hidden">
                    <app-smart-image [src]="team.logo" type="team" size="lg" [initials]="team.name.charAt(0)" />
                </div>

                <!-- Identity Details -->
                <div class="flex-1">
                    <div class="flex items-center gap-4 mb-3 mobile-center">
                        @if (!isEditingName) {
                        <h1 class="text-4xl font-super-black text-primary mb-0 tracking-tighter">{{ team.name }}
                        </h1>
                        @if (canEditName) {
                        <app-button (click)="startEditName()" variant="ghost" size="sm" icon="edit"
                            class="text-primary-light" />
                        }
                        @if (canDeleteTeam) {
                        <app-button (click)="onDeleteTeamClick()" variant="danger-ghost" size="sm" icon="delete"
                            title="حذف الفريق" />
                        }
                        }

                        @if (isEditingName) {
                        <div class="flex items-center gap-2">
                            <!-- eslint-disable-next-line @angular-eslint/template/no-inline-styles -->
                            <input [(ngModel)]="tempName"
                                class="text-4xl font-super-black text-primary bg-surface border-primary rounded-xl px-3 outline-none"
                                [style.width]="'auto'" [style.max-width.px]="300">
                            <app-button (click)="saveName()" variant="primary" size="sm" icon="check" />
                            <app-button (click)="cancelEdit()" variant="ghost" size="sm" icon="close" />
                        </div>
                        }

                        <app-badge [type]="team.status === 'READY' ? 'success' : 'warning'" [dot]="true"
                            [dotType]="team.status === 'READY' ? 'active' : 'pending'" class="px-3">
                            {{ team.status === 'READY' ? 'فريق مكتمل' : 'فريق غير مكتمل' }}
                        </app-badge>

                        @if (canManageStatus && team.isActive) {
                        <app-button (click)="onDisableTeamClick()" variant="danger" size="sm" icon="block"
                            class="ms-auto">تعطيل الفريق</app-button>
                        }
                    </div>

                    <div class="flex items-center gap-lg flex-wrap mobile-center">
                        <div class="flex items-center gap-2 text-muted font-bold text-sm">
                            <app-icon name="location_on" class="text-gold opacity-70 icon-sm"></app-icon>
                            <span>{{ team.city }}</span>
                        </div>
                        <div class="flex items-center gap-2 text-muted font-bold text-sm">
                            <app-icon name="person" class="text-primary opacity-70 icon-sm"></app-icon>
                            <span>الكابتن: <span class="text-primary-light">{{ team.captainName }}</span></span>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Team Disabled Banner -->
        @if (!team.isActive) {
        <div class="card bg-danger bg-opacity-10 border-danger border-opacity-20 p-lg animate-pulse-subtle">
            <div class="flex items-center gap-4 text-danger">
                <app-icon name="warning" class="text-3xl icon-sm"></app-icon>
                <div class="flex-col">
                    <h4 class="font-super-black mb-1">تم تعطيل هذا الفريق بواسطة الإدارة</h4>
                    <p class="text-sm opacity-80 mb-0">تم إيقاف كافة الأنشطة التنافسية لهذا الفريق وانسحابه من البطولات
                        الحالية.</p>
                </div>
            </div>
        </div>
        }

        <!-- Tabbed Content Section -->
        <div class="tabs-scroll-container">
            <app-filter [items]="filteredTabs" [activeValue]="activeTab" (filterChange)="onTabChange($event)" />
        </div>

        <!-- Dynamic Content Area -->
        <div class="animate-fade-in-up">
            @switch (activeTab) {

            <!-- Overview Tab (Stats Dashboard) -->
            @case ('overview') {
            <div class="flex-col gap-lg">
                <div class="grid-stats">
                    <div class="stat-card">
                        <div class="stat-card-decoration"><app-icon name="sports_soccer" class=" icon-sm"></app-icon>
                        </div>
                        <span class="stat-card-label">المباريات</span>
                        <span class="stat-card-value">{{ team.stats.matches }}</span>
                    </div>
                    <div class="stat-card border-success border-opacity-20">
                        <div class="stat-card-decoration bg-success bg-opacity-5"><app-icon name="check_circle"
                                class="text-success icon-sm"></app-icon></div>
                        <span class="stat-card-label text-success">انتصار</span>
                        <span class="stat-card-value text-success">{{ team.stats.wins }}</span>
                    </div>
                    <div class="stat-card border-warning border-opacity-20">
                        <div class="stat-card-decoration bg-warning bg-opacity-5"><app-icon name="balance"
                                class="text-warning icon-sm"></app-icon></div>
                        <span class="stat-card-label text-warning">تعادل</span>
                        <span class="stat-card-value text-warning">{{ team.stats.draws }}</span>
                    </div>
                    <div class="stat-card border-danger border-opacity-20">
                        <div class="stat-card-decoration bg-danger bg-opacity-5"><app-icon name="cancel"
                                class="text-danger icon-sm"></app-icon></div>
                        <span class="stat-card-label text-danger">هزيمة</span>
                        <span class="stat-card-value text-danger">{{ team.stats.losses }}</span>
                    </div>
                </div>

                <div class="grid-2-cols">
                    <!-- Goals Analytics -->
                    <div class="card p-lg border-primary border-opacity-10">
                        <div class="flex-between items-center mb-8">
                            <h3 class="font-super-black text-lg mb-0">تحليل الأهداف</h3>
                            <app-icon name="monitoring" class="text-primary icon-sm"></app-icon>
                        </div>
                        <div class="flex items-center gap-xl">
                            <div class="flex-1 flex-col items-center border-l border-visible text-center">
                                <span class="text-3xl font-super-black text-success">{{ team.stats.goalsFor }}</span>
                                <span class="text-2xs uppercase font-bold text-muted">أهداف مسجلة</span>
                            </div>
                            <div class="flex-1 flex-col items-center text-center">
                                <span class="text-3xl font-super-black text-danger">{{ team.stats.goalsAgainst }}</span>
                                <span class="text-2xs uppercase font-bold text-muted">أهداف مستقبلة</span>
                            </div>
                        </div>
                    </div>

                    <div class="flex-between bg-surface p-3 rounded-xl border border-visible">
                        <span class="text-muted text-sm font-bold">اكتمال القائمة</span>
                        <span class="text-primary-light font-super-black">{{ team.players.length }} / {{ team.maxPlayers
                            || 10 }}</span>
                    </div>
                </div>
            </div>
            }

            <!-- Players Tab (Grid View) -->
            @case ('players') {
            <div class="flex-col gap-md">
                @if (canAddPlayers) {
                <div class="flex justify-end mb-4">
                    <app-button (click)="onAddPlayerClick()" variant="primary" icon="person_add">إضافة لاعب
                        جديد</app-button>
                </div>
                }
                <div class="grid-2-cols gap-md">
                    @for (player of team.players; track player.id) {
                    <div class="player-mobile-card p-3">
                        <div class="flex items-center gap-4">
                            <div class="player-avatar-pill">
                                <app-smart-image [src]="null" type="avatar" size="sm"
                                    [initials]="player.name.charAt(0)" />
                            </div>
                            <div class="flex-1">
                                <div class="flex-between items-center">
                                    <div class="flex-col items-start">
                                        <div class="flex items-center gap-2">
                                            <span class="text-sm font-super-black text-primary">{{ player.name }}</span>
                                            <span class="text-xs text-muted">#{{ player.number }}</span>
                                        </div>
                                        <div class="status-wrapper">
                                            <span class="status-label"
                                                [class.status-active]="player.status === 'active'"
                                                [class.status-suspended]="player.status === 'suspended'"
                                                [class.status-banned]="player.status === 'banned'">
                                                {{ getPlayerStatusLabel(player.status) }}
                                            </span>
                                        </div>
                                    </div>
                                    <div class="flex items-center gap-1">
                                        @if (canManageStatus) {
                                        @if (player.status !== 'active') {
                                        <app-button (click)="requestPlayerAction(player, 'activate')" variant="ghost"
                                            size="sm" icon="check_circle" class="text-success" />
                                        }
                                        @if (player.status === 'active') {
                                        <app-button (click)="requestPlayerAction(player, 'deactivate')" variant="ghost"
                                            size="sm" icon="block" class="text-warning" />
                                        }
                                        <app-button (click)="requestPlayerAction(player, 'ban')" variant="ghost"
                                            size="sm" icon="person_off" class="text-danger" />
                                        }

                                        @if (canRemovePlayers && player.teamRole !== 'Captain') {
                                        <app-button (click)="requestPlayerAction(player, 'remove')" variant="ghost"
                                            size="sm" icon="delete" class="text-danger" />
                                        }
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    }
                </div>
            </div>
            }

            <!-- Matches Tab (Match Cards) -->
            @case ('matches') {
            <div class="flex-col gap-4">
                @if (!team.matches || team.matches.length === 0) {
                <div class="empty-state p-xl text-center">
                    <app-icon name="sports_soccer" class="text-4xl opacity-20 mb-4 icon-sm"></app-icon>
                    <p class="text-muted">لا يوجد مباريات مسجلة حالياً</p>
                </div>
                }

                @for (match of team.matches; track match.id) {
                <div class="card p-0 overflow-hidden match-pro-card">
                    <div class="match-card-header flex-between p-3">
                        <div class="flex items-center gap-2">
                            <app-badge type="gold" class="text-2xs px-2">{{ match.type }}</app-badge>
                            <span class="text-2xs font-bold text-muted">{{ match.date | date:'y/MM/dd | HH:mm'
                                }}</span>
                        </div>
                        <app-icon name="more_horiz" class="text-sm text-muted opacity-50 icon-sm"></app-icon>
                    </div>

                    <div class="p-lg flex items-center justify-between gap-xl mobile-center">
                        <div class="flex-1 flex flex-col items-center gap-3">
                            <app-smart-image [src]="team.logo" type="team" size="md" [initials]="team.name.charAt(0)" />
                            <span class="text-sm font-super-black text-primary">{{ team.name }}</span>
                        </div>

                        <div class="flex flex-col items-center gap-2">
                            <div class="flex items-center gap-5">
                                <span class="text-5xl font-super-black text-primary">{{ match.teamScore ?? 0
                                    }}</span>
                                <span class="text-muted opacity-30 text-3xl">:</span>
                                <span class="text-5xl font-super-black text-primary">{{ match.opponentScore ?? 0
                                    }}</span>
                            </div>
                            <app-badge
                                [type]="match.status === 'Finished' ? 'success' : (match.status === 'Scheduled' ? 'warning' : 'primary')">
                                {{ match.status === 'Finished' ? 'مباراة منتهية' : (match.status === 'Scheduled' ?
                                'مجدولة'
                                : 'جارية الآن') }}
                            </app-badge>
                        </div>

                        <div class="flex-1 flex flex-col items-center gap-3">
                            <app-smart-image [src]="match.opponentLogo" type="team" size="md"
                                [initials]="match.opponent.charAt(0)" />
                            <span class="text-sm font-super-black text-primary">{{ match.opponent }}</span>
                        </div>
                    </div>
                </div>
                }
            </div>
            }

            <!-- Finances Tab (Financial Grid) -->
            @case ('finances') {
            <div class="flex-col gap-md">
                @if (!team.finances || team.finances.length === 0) {
                <div class="empty-state p-xl text-center">
                    <app-icon name="account_balance_wallet" class="text-4xl opacity-20 mb-4 icon-sm"></app-icon>
                    <p class="text-muted">لا يوجد سجل مالي حالياً</p>
                </div>
                }

                <div class="grid-2-cols gap-md">
                    @for (entry of team.finances; track entry.id) {
                    <div class="card p-md finance-entry">
                        <div class="flex-between items-center mb-4">
                            <div class="flex flex-col">
                                <span class="text-xs text-muted font-bold mb-1">{{ entry.date | date:'y/MM/dd'
                                    }}</span>
                                <span class="text-base font-super-black text-primary">{{ entry.title }}</span>
                            </div>
                            <div class="flex flex-col items-end">
                                <app-badge
                                    [type]="entry.status === 'Approved' ? 'success' : (entry.status === 'Rejected' ? 'danger' : 'warning')"
                                    [dot]="true">
                                    {{ entry.status === 'Approved' ? 'تم الاعتماد' : (entry.status === 'Rejected' ?
                                    'مرفوض'
                                    : 'قيد المراجعة') }}
                                </app-badge>
                            </div>
                        </div>
                    </div>
                    }
                </div>
            </div>
            }

            <!-- Requests/Invitations Tab -->
            @case ('requests') {
            <div class="flex-col gap-4">
                @if (!team.invitations || team.invitations.length === 0) {
                <div class="empty-state p-xl text-center">
                    <app-icon name="mail_outline" class="text-4xl opacity-20 mb-4 icon-sm"></app-icon>
                    <p class="text-muted">لا يوجد طلبات أو دعوات معلقة حالياً</p>
                </div>
                }

                @for (request of team.invitations; track request.id) {
                <div class="card p-md flex-between items-center animate-fade-in">
                    <div class="flex items-center gap-3">
                        <app-smart-image [src]="null" type="avatar" size="sm"
                            [initials]="request.playerName.charAt(0) || 'P'" />
                        <div class="flex-col">
                            <span class="font-bold">{{ request.playerName }}</span>
                            <span class="text-xs text-muted">أرسلت في: {{ request.requestDate | date:'y/MM/dd'
                                }}</span>
                        </div>
                    </div>
                    <div class="flex items-center gap-2">
                        <app-badge [type]="request.status === 'pending' ? 'warning' : 'success'">
                            {{ request.status === 'pending' ? 'بانتظار الرد' : request.status }}
                        </app-badge>

                        @if (canManageInvitations && request.status === 'pending') {
                        <div class="flex gap-1">
                            <app-button (click)="onRespondRequest(request, true)" variant="ghost" size="sm" icon="check"
                                class="text-success" />
                            <app-button (click)="onRespondRequest(request, false)" variant="ghost" size="sm"
                                icon="close" class="text-danger" />
                        </div>
                        }
                    </div>
                </div>
                }
            </div>
            }
            }

        </div>
    </div>

    <!-- Modal: Add Player by ID -->
    <app-modal [visible]="isInviteModalOpen" title="إضافة لاعب جديد" (closeRequest)="closeInviteModal()">

        <div class="flex-col gap-4">
            <p class="text-muted text-sm mb-2">
                يرجى إدخال الرقم التعريفي للاعب (Display ID) المسجل في المنصة لإرسال دعوة انضمام له.
            </p>

            <app-form-control label="الرقم التعريفي للاعب" [formControl]="displayIdControl" placeholder="مثال: #123456"
                iconLeft="badge" />
        </div>

        <div footer class="flex gap-3 w-full">
            <app-button variant="outline" class="flex-1" (click)="closeInviteModal()">
                إلغاء
            </app-button>
            <app-button variant="primary" class="flex-1" icon="send" [isLoading]="isInviteLoading"
                (click)="submitAddPlayer()">
                إرسال الدعوة
            </app-button>
        </div>
    </app-modal>
</div>