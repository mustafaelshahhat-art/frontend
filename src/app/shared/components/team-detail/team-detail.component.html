<div class="page-container animate-fade-in">
    <div class="page-content flex-col gap-lg">


        <!-- Team Identity Hero -->
        <div class="card p-0 relative overflow-hidden">
            <!-- Glass Header Background -->
            <div class="absolute inset-0 bg-gradient-to-r from-primary to-transparent opacity-5"></div>

            <div class="flex items-center gap-xl p-lg flex-wrap mobile-center relative">
                <!-- Team Logo Square (Premium) -->
                <div class="avatar-xl shadow-glow-sm border-4 border-surface-light">
                    <img class="avatar-img" [src]="team.logo" [alt]="team.name">
                </div>

                <!-- Identity Details -->
                <div class="flex-1">
                    <div class="flex items-center gap-4 mb-3 mobile-center">
                        <ng-container *ngIf="!isEditingName">
                            <h1 class="text-4xl font-super-black text-primary mb-0 tracking-tighter">{{ team.name }}
                            </h1>
                            <app-button *ngIf="canEditName" (click)="startEditName()" variant="ghost" size="sm"
                                icon="edit" class="text-primary-light"></app-button>
                            <app-button *ngIf="canDeleteTeam" (click)="onDeleteTeamClick()" variant="ghost" size="sm"
                                icon="delete" class="text-danger" title="حذف الفريق"></app-button>
                        </ng-container>

                        <div *ngIf="isEditingName" class="flex items-center gap-2">
                            <input [(ngModel)]="tempName"
                                class="text-4xl font-super-black text-primary bg-surface border-primary rounded-xl px-3 outline-none"
                                style="width: auto; max-width: 300px;">
                            <app-button (click)="saveName()" variant="primary" size="sm" icon="check"></app-button>
                            <app-button (click)="cancelEdit()" variant="ghost" size="sm" icon="close"></app-button>
                        </div>

                        <app-badge [type]="team.status === 'READY' ? 'success' : 'warning'" [dot]="true"
                            [dotType]="team.status === 'READY' ? 'active' : 'pending'" class="px-3">
                            {{ team.status === 'READY' ? 'فريق مكتمل' : 'فريق غير مكتمل' }}
                        </app-badge>
                    </div>

                    <div class="flex items-center gap-lg flex-wrap mobile-center">
                        <div class="flex items-center gap-2 text-muted font-bold text-sm">
                            <span class="material-symbols-outlined text-gold opacity-70">location_on</span>
                            <span>{{ team.city }}</span>
                        </div>
                        <div class="flex items-center gap-2 text-muted font-bold text-sm">
                            <span class="material-symbols-outlined text-primary opacity-70">person</span>
                            <span>الكابتن: <span class="text-primary-light">{{ team.captainName }}</span></span>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Tabbed Content Section -->
        <div class="tabs-scroll-container">
            <app-filter [items]="filteredTabs" [activeValue]="activeTab" (change)="onTabChange($event)"></app-filter>
        </div>

        <!-- Dynamic Content Area -->
        <div [ngSwitch]="activeTab" class="animate-fade-in-up">

            <!-- Overview Tab (Stats Dashboard) -->
            <div *ngSwitchCase="'overview'" class="flex-col gap-lg">
                <div class="grid-stats">
                    <div class="stat-card">
                        <div class="stat-card-decoration"><span class="material-symbols-outlined">sports_soccer</span>
                        </div>
                        <span class="stat-card-label">المباريات</span>
                        <span class="stat-card-value">{{ team.stats.matches }}</span>
                    </div>
                    <div class="stat-card border-success border-opacity-20">
                        <div class="stat-card-decoration bg-success bg-opacity-5"><span
                                class="material-symbols-outlined text-success">check_circle</span></div>
                        <span class="stat-card-label text-success">انتصار</span>
                        <span class="stat-card-value text-success">{{ team.stats.wins }}</span>
                    </div>
                    <div class="stat-card border-warning border-opacity-20">
                        <div class="stat-card-decoration bg-warning bg-opacity-5"><span
                                class="material-symbols-outlined text-warning">balance</span></div>
                        <span class="stat-card-label text-warning">تعادل</span>
                        <span class="stat-card-value text-warning">{{ team.stats.draws }}</span>
                    </div>
                    <div class="stat-card border-danger border-opacity-20">
                        <div class="stat-card-decoration bg-danger bg-opacity-5"><span
                                class="material-symbols-outlined text-danger">cancel</span></div>
                        <span class="stat-card-label text-danger">هزيمة</span>
                        <span class="stat-card-value text-danger">{{ team.stats.losses }}</span>
                    </div>
                </div>

                <div class="grid-2-cols">
                    <!-- Goals Analytics -->
                    <div class="card p-lg border-primary border-opacity-10">
                        <div class="flex-between items-center mb-8">
                            <h3 class="font-super-black text-lg mb-0">تحليل الأهداف</h3>
                            <span class="material-symbols-outlined text-primary">monitoring</span>
                        </div>
                        <div class="flex items-center gap-xl">
                            <div class="flex-1 flex-col items-center border-l border-visible text-center">
                                <span class="text-3xl font-super-black text-success">{{ team.stats.goalsFor }}</span>
                                <span class="text-2xs uppercase font-bold text-muted">أهداف مسجلة</span>
                            </div>
                            <div class="flex-1 flex-col items-center text-center">
                                <span class="text-3xl font-super-black text-danger">{{ team.stats.goalsAgainst }}</span>
                                <span class="text-2xs uppercase font-bold text-muted">أهداف مستقبلة</span>
                            </div>
                        </div>
                    </div>

                    <div class="flex-between bg-surface p-3 rounded-xl border border-visible">
                        <span class="text-muted text-sm font-bold">اكتمال القائمة</span>
                        <span class="text-primary-light font-super-black">{{ team.players.length }} / {{ team.maxPlayers
                            || 10 }}</span>
                    </div>
                </div>
            </div>

            <!-- Players Tab (Grid View) -->
            <div *ngSwitchCase="'players'" class="flex-col gap-md">
                <div *ngIf="canAddPlayers" class="flex justify-end mb-4">
                    <app-button (click)="onAddPlayerClick()" variant="primary" icon="person_add">إضافة لاعب
                        جديد</app-button>
                </div>
                <div class="grid-2-cols gap-md">
                    <div *ngFor="let player of team.players" class="player-mobile-card p-3">
                        <div class="flex items-center gap-4">
                            <div class="player-avatar-pill">
                                <div
                                    class="avatar avatar-md bg-primary bg-opacity-10 rounded-xl flex items-center justify-center font-super-black text-primary">
                                    {{ player.name.charAt(0) }}
                                </div>
                            </div>
                            <div class="flex-1">
                                <div class="flex-between items-center">
                                    <div class="flex-col items-start">
                                        <div class="flex items-center gap-2">
                                            <span class="text-sm font-super-black text-primary">{{ player.name }}</span>
                                            <span class="text-xs text-muted">#{{ player.number }}</span>
                                        </div>
                                        <div class="status-wrapper">
                                            <span class="status-label"
                                                [class.status-active]="player.status === 'active'"
                                                [class.status-suspended]="player.status === 'suspended'"
                                                [class.status-banned]="player.status === 'banned'">
                                                {{ getPlayerStatusLabel(player.status) }}
                                            </span>
                                        </div>
                                    </div>
                                    <div class="flex items-center gap-1">
                                        <ng-container *ngIf="canManageStatus">
                                            <app-button *ngIf="player.status !== 'active'"
                                                (click)="requestPlayerAction(player, 'activate')" variant="ghost"
                                                size="sm" icon="check_circle" class="text-success"></app-button>
                                            <app-button *ngIf="player.status === 'active'"
                                                (click)="requestPlayerAction(player, 'deactivate')" variant="ghost"
                                                size="sm" icon="block" class="text-warning"></app-button>
                                            <app-button (click)="requestPlayerAction(player, 'ban')" variant="ghost"
                                                size="sm" icon="person_off" class="text-danger"></app-button>
                                        </ng-container>

                                        <app-button *ngIf="canRemovePlayers"
                                            (click)="requestPlayerAction(player, 'remove')" variant="ghost" size="sm"
                                            icon="delete" class="text-danger"></app-button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Matches Tab (Match Cards) -->
            <div *ngSwitchCase="'matches'" class="flex-col gap-4">
                <div *ngIf="!team.matches || team.matches.length === 0" class="empty-state p-xl text-center">
                    <span class="material-symbols-outlined text-4xl opacity-20 mb-4">sports_soccer</span>
                    <p class="text-muted">لا يوجد مباريات مسجلة حالياً</p>
                </div>

                <div *ngFor="let match of team.matches" class="card p-0 overflow-hidden match-pro-card">
                    <div class="match-card-header flex-between p-3">
                        <div class="flex items-center gap-2">
                            <app-badge type="gold" class="text-2xs px-2">{{ match.type }}</app-badge>
                            <span class="text-2xs font-bold text-muted">{{ match.date | date:'y/MM/dd | HH:mm'
                                }}</span>
                        </div>
                        <span class="material-symbols-outlined text-sm text-muted opacity-50">more_horiz</span>
                    </div>

                    <div class="p-lg flex items-center justify-between gap-xl mobile-center">
                        <div class="flex-1 flex flex-col items-center gap-3">
                            <div class="avatar-lg bg-surface border border-visible shadow-sm">
                                <img [src]="team.logo" class="avatar-img" alt="">
                            </div>
                            <span class="text-sm font-super-black text-primary">{{ team.name }}</span>
                        </div>

                        <div class="flex flex-col items-center gap-2">
                            <div class="flex items-center gap-5">
                                <span class="text-5xl font-super-black text-primary">{{ match.homeScore ?? 0
                                    }}</span>
                                <span class="text-muted opacity-30 text-3xl">:</span>
                                <span class="text-5xl font-super-black text-primary">{{ match.awayScore ?? 0
                                    }}</span>
                            </div>
                            <app-badge
                                [type]="match.status === 'Finished' ? 'success' : (match.status === 'Scheduled' ? 'warning' : 'primary')">
                                {{ match.status === 'Finished' ? 'مباراة منتهية' : (match.status === 'Scheduled' ?
                                'مجدولة'
                                : 'جارية الآن') }}
                            </app-badge>
                        </div>

                        <div class="flex-1 flex flex-col items-center gap-3">
                            <div class="avatar-lg bg-surface border border-visible shadow-sm">
                                <img src="https://cdn-icons-png.flaticon.com/512/1165/1165217.png" class="avatar-img"
                                    alt="">
                            </div>
                            <span class="text-sm font-super-black text-primary">{{ match.opponent }}</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Finances Tab (Financial Grid) -->
            <div *ngSwitchCase="'finances'" class="flex-col gap-md">
                <div *ngIf="!team.finances || team.finances.length === 0" class="empty-state p-xl text-center">
                    <span class="material-symbols-outlined text-4xl opacity-20 mb-4">account_balance_wallet</span>
                    <p class="text-muted">لا يوجد سجل مالي حالياً</p>
                </div>

                <div class="grid-2-cols gap-md">
                    <div *ngFor="let entry of team.finances" class="card p-md finance-entry">
                        <div class="flex-between items-center mb-4">
                            <div class="flex flex-col">
                                <span class="text-xs text-muted font-bold mb-1">{{ entry.date | date:'y/MM/dd'
                                    }}</span>
                                <span class="text-base font-super-black text-primary">{{ entry.title }}</span>
                            </div>
                            <div class="flex flex-col items-end">
                                <app-badge
                                    [type]="entry.status === 'Approved' ? 'success' : (entry.status === 'Rejected' ? 'danger' : 'warning')"
                                    [dot]="true">
                                    {{ entry.status === 'Approved' ? 'تم الاعتماد' : (entry.status === 'Rejected' ?
                                    'مرفوض'
                                    : 'قيد المراجعة') }}
                                </app-badge>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Requests/Invitations Tab -->
            <div *ngSwitchCase="'requests'" class="flex-col gap-4">
                <div *ngIf="!team.invitations || team.invitations.length === 0" class="empty-state p-xl text-center">
                    <span class="material-symbols-outlined text-4xl opacity-20 mb-4">mail_outline</span>
                    <p class="text-muted">لا يوجد طلبات أو دعوات معلقة حالياً</p>
                </div>

                <div *ngFor="let request of team.invitations"
                    class="card p-md flex-between items-center animate-fade-in">
                    <div class="flex items-center gap-3">
                        <div class="avatar avatar-md bg-surface-light text-primary font-bold">
                            {{ request.playerName?.charAt(0) || 'P' }}
                        </div>
                        <div class="flex-col">
                            <span class="font-bold">{{ request.playerName }}</span>
                            <span class="text-xs text-muted">أرسلت في: {{ request.requestDate | date:'y/MM/dd'
                                }}</span>
                        </div>
                    </div>
                    <div class="flex items-center gap-2">
                        <app-badge [type]="request.status === 'pending' ? 'warning' : 'success'">
                            {{ request.status === 'pending' ? 'بانتظار الرد' : request.status }}
                        </app-badge>

                        <div *ngIf="canManageInvitations && request.status === 'pending' && request.initiatedByPlayer"
                            class="flex gap-1">
                            <app-button (click)="onRespondRequest(request, true)" variant="ghost" size="sm" icon="check"
                                class="text-success"></app-button>
                            <app-button (click)="onRespondRequest(request, false)" variant="ghost" size="sm"
                                icon="close" class="text-danger"></app-button>
                        </div>
                    </div>
                </div>
            </div>

        </div>
    </div>

    <!-- Modal: Add Player by ID -->
    <div *ngIf="showAddPlayerModal" class="modal-backdrop animate-fade-in" (click)="closeAddPlayerModal()">
        <div class="modal-container mobile-bottom animate-slide-up" (click)="$event.stopPropagation()">
            <div class="modal-header border-none pb-0">
                <h3 class="font-super-black text-xl mb-0">إضافة لاعب جديد</h3>
                <button class="close-btn" (click)="closeAddPlayerModal()">
                    <span class="material-symbols-outlined">close</span>
                </button>
            </div>

            <div class="modal-body pt-4">
                <p class="text-muted text-sm mb-6">يرجى إدخال الرقم التعريفي للاعب (Display ID) المسجل في المنصة
                    لإرسال
                    دعوة انضمام له.</p>

                <div class="input-group">
                    <span class="material-symbols-outlined input-icon">badge</span>
                    <input type="text" [(ngModel)]="playerSearchId" placeholder="مثال: #123456" class="form-control-lg"
                        (keyup.enter)="submitAddPlayer()">
                </div>
            </div>

            <div class="modal-footer border-none pt-0 pb-lg">
                <app-button variant="ghost" class="flex-1" (click)="closeAddPlayerModal()">إلغاء</app-button>
                <app-button variant="primary" class="flex-1" icon="send" (click)="submitAddPlayer()">إرسال
                    الدعوة</app-button>
            </div>
        </div>
    </div>
</div>